<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3: Project Birds Mapping</title>
        <script type="text/javascript" src="../d3/d3.min.js"></script>
        <style type="text/css">
			body {
			  background-color: #faf5df;
			}
			text {
			  font-size: 12px;
			  font-family: "Sawasdee", "URW Gothic L", sans;
			  //fill: white;
			}
			text.label {
			  font-size: 18px;
			}
			text.expl {
			  font-size: 11px;
			}
			text.title {
			  font-size: 24px;
			  font-weight: bold;
			}
			text.active {
			  fill: #dd2f00;
			}

			.axis {
			  fill: none;
			  stroke: #222;
			}

			path {
			  stroke: #554508;
			}
			path.pointer {
			  stroke: #222;
			}
			line {
			  stroke: #222;
			}
			rect {
			  stroke: #222;
			}
            

            path:hover {
				fill: orange;
			}

            #tooltip {
			        position: absolute;
			        padding: 10px;
			        background-color: white;
			        -webkit-border-radius: 10px;
			        -moz-border-radius: 10px;
			        border-radius: 10px;
			        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			        pointer-events: none;
			}

			#tooltip.hidden {
			        display: none;
			}

			#tooltip p {
			        margin: 0;
			        font-family: sans-serif;
			        font-size: 16px;
			        line-height: 20px;
			}
			
			#states path {
			  fill: #ccc;
			  stroke: #fff;
			}

			path.arc {
			  pointer-events: none;
			  fill: none;
			  stroke: #000;
			  display: none;
			}

			path.cell {
			  fill: none;
			  pointer-events: all;
			}

			circle {
			  fill: steelblue;
			  fill-opacity: .8;
			  stroke: #fff;
			}
			
			.background {
			  fill: none;
			  pointer-events: all;
			  stroke: #000;
			  stroke-width : 2;
			}
			
			.background2 {
			  fill: none;
			  pointer-events: all;
			  stroke: #000;
			  stroke-width : 2;
			}
			
			.tblinfo {
				font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
				width: 100%;
				border-collapse: collapse;
			}

			.tblinfo td, .tblinfo th {
				font-size: 1em;
				border: 1px solid #98bf21;
				padding: 3px 7px 2px 7px;
			}

			.tblinfo th {
				font-size: 1.1em;
				text-align: left;
				padding-top: 5px;
				padding-bottom: 4px;
				background-color: #A7C942;
				color: #ffffff;
			}

			.tblinfo tr.alt td {
				color: #000000;
				background-color: #EAF2D3;
			}
			
			table {
			  font-family: "Helvetica", "Lucida Sans", "Lucida Sans Unicode", "Luxi Sans", Tahoma, sans-serif;
			  box-shadow: 1px 1px 10px rgba(0,0,0,0.5);
			  border-collapse: collapse;
			  border-spacing: 0;
			}
			table {
			  margin: auto;
			}
			table, td, th {
			  width: 100%;
			  padding: 7px;
			  text-align: center;
			  border: 1px solid rgb(8,48,107);
			}
			th {
			  background-color: rgb(8,81,156);
			  color: white;
			}
			
			.outer {
				width: 300px;
				height: 500px;
				overflow: auto;
			}
			.inner {
				width: 300px;
				height: 500px;
			}
			#InfoTab{
				display: block;
				
			}
			
			#legendJKT.hidden, #legendJKTR.hidden, #legendJV.hidden, #legendJVR.hidden {
			        display: none;
			}
			
			#ljv1.hidden, #ljv2.hidden, #ljv3.hidden, #ljv4.hidden, #ljv5.hidden {
			        display: none;
			}
			
			#ljkt1.hidden, #ljkt2.hidden, #ljkt3.hidden, #ljkt4.hidden, #ljkt5.hidden {
			        display: none;
			}
			
			#ljvb1.hidden, #ljvb2.hidden, #ljvb3.hidden, #ljvb4.hidden, #ljvb5.hidden {
			        display: none;
			}
			
			#ljktb1.hidden, #ljktb2.hidden, #ljktb3.hidden, #ljktb4.hidden, #ljktb5.hidden {
			        display: none;
			}
			
        </style>
    </head>
    <body>
        <div id="tooltip" class="hidden">
	        <p><strong><span id="daerah"></span></strong></p>
	        <p id="info">Additional Information for selected area can be showed here</p>
		</div>

        <script type="text/javascript">
        
        //var global
            var margin = 25,
            	marginforlegend = 10,
				width = window.innerWidth - margin,
				height = window.innerHeight - margin;
				if (width < 1000) { width = 1000 }
				if (height < 800) { height = 800 }
			
			var	clistw = 250,
				clisth = 300,
				jktw = (width-15*margin),///2,
				jkth = (height-8*margin)*5/8,//jktw*3/4,
				jktx = width-jktw-15*margin,//400,
				jww = width-15*margin,
				jwh = (height-8*margin)*3/8//height-7*margin,//height-jkth-5*margin,
				filterwidth = 120,
				widthbuble = 250,
				heightbuble = 70,
				leftbuble = width - 2.5*margin - widthbuble,
				topbuble = 6*margin+8,
				
				svg = d3.select("body")
					.append("svg:svg")
					.attr("height", height)
					.attr("width", width)
					.attr("border",1),
				defs = svg.append("svg:defs"),
				canvas = svg.append("svg:g")
					.attr("id", "canvas")
					.attr("height", height - 5*margin)
					.attr("transform", "translate("+margin+","+6*margin+")"),
				label = canvas.append("svg:g")
					.attr("id", "label")
					.attr("transform", "translate("+clistw+",0)"),
				map2 = canvas.append("svg:svg")
					.attr("id", "map2")
					.attr("x", 0)
					.attr("y", jkth)
					.attr("width", jww)
					.attr("height", jwh)
					.append("svg:g"),
				map = canvas.append("svg:svg")
					.attr("id", "map")
					.attr("x", 0)
					.attr("width", jktw)
					.attr("height", jkth)
					.append("svg:g"),
				clist = canvas.append("svg:g")
					.attr("id", "clist")
					.attr("width", clistw),
				
            //Width and height for jabodetabek
            	projection = d3.geo.mercator()
                               .rotate([-105.8,5.9,0])//([-106.2,5.9,0])
    						   .scale(width*20)//(width*15)
                               .translate([0, 0]),                 
            	path = d3.geo.path().projection(projection),
            	
            	zoom = d3.behavior.zoom()
					.on("zoom", zoomed);
							
				map.append("rect")
    				.attr("id", "gjkt rect")
					.attr("class", "background")
					.attr("width", jktw)
					.attr("height", jkth);
					
				var gjkt = map.append("g")
					.attr("id", "gjkt")
    				.call(zoom);
    				
    			
            
            //Width and height for java island   
            var projection2 = d3.geo.mercator()
                                .rotate([-105,5.7,0])
    						    .scale(width*3.8)
                                .translate([0, 0]),                  
            	path2 = d3.geo.path().projection(projection2),
            
            	zoom2 = d3.behavior.zoom()
					.on("zoom", zoomed2);
							
				map2.append("rect")
					.attr("id", "gjw rect")
					.attr("class", "background2")
					.attr("width", jww)
					.attr("height", jwh);
				
				var gjw = map2.append("g")
					.attr("id", "gjw")
    				.call(zoom2);
    				
    		//global variable to store data movement csv
			var data = [],
				datadump = [],	
			
				javjson = [],
				jakjson = [],
				cities = [], 
				unique_areatarget = [],
				datamovjav = [],
				datamovjak = [],
				linksByOrigin = {},
				countByCity = {},
				locationByCity = {},
				positions = [],
				positions2 = [],
				minmaxvaljkt = [],
				minmaxvaljv = [],
				dt_lbm = [],	
				
				originmenu = "",//F1
				collectormenu = "",//F2
				destinationmenu = "",//F3
				speciesmenu = [],//F4
				connectionmenu = "",//F5
				
				ljv1 = 0,
				ljv2 = 0,
				ljv3 = 0,
				ljv4 = 0,
				ljv5 = 0,
				ljkt1 = 0,
				ljkt2 = 0,
				ljkt3 = 0,
				ljkt4 = 0,
				ljkt5 = 0,	
				
				ForFilter,
				DvalueForFilter;	//global variabel to pass value from selected origin to filter		
			
            var setNormalColor = function(d)
            {
                //Get data value
                  var value = d.properties.value;
                  
                    if (value) {
                            //If value exists…
                            return color(value);
                    } else {
                            //If value is undefined…
                        	return "white";
                    }
            }
            
            var setJktColor = function(d)
            {
                //Get data total
				var totalweeklvolume =  d.properties.total ;
                  
				if (totalweeklvolume) 
                {
                	
					if (totalweeklvolume <= ljkt2){return "#D1FFD5"}
					
					else if (totalweeklvolume <= ljkt3){return "#00FF1E"}
					
					else if (totalweeklvolume <= ljkt4){return "#828CFF"}
					
					else if (totalweeklvolume <= ljkt5){return "#0015FF"}
                    
                } 
                else 
                {
                    //If value is undefined…
                    return "#FFFFFF"
                }
            }
            
            var setJktColorSDLBM = function(d)
            {
                //Get data total

				var totalweeklvolume =  d.total  ;
                  
				if (totalweeklvolume) 
                {
                	
					if (totalweeklvolume <= ljkt2){return "#D1FFD5"}
					
					else if (totalweeklvolume <= ljkt3){return "#00FF1E"}
					
					else if (totalweeklvolume <= ljkt4){return "#828CFF"}
					
					else if (totalweeklvolume <= ljkt5){return "#0015FF"}
                    
                } 
                else 
                {
                    //If value is undefined…
                    return "#FFFFFF"
                }
            }
            
            var setJavColor = function(d)
            {
                //Get data total

				var totalweekllvolume = d.properties.total;
                  
				if (totalweekllvolume) 
                {
                	
					if (totalweekllvolume <= ljv2){return "#FCDF7E"}
					
					else if (totalweekllvolume <= ljv3){return "#FFC400"}
					
					else if (totalweekllvolume <= ljv4){return "#FF7D7D"}
					
					else if (totalweekllvolume <= ljv5){return "#FF0000"}
                    
                } 
                else 
                {
                    //If value is undefined…
                    return "#FFFFFF"
                }
            }
            
            //function to get distinguish origin area
            var getOriginCity = function (d) 
            {
				var areaorigin = [];
				var n = 0;
				var areaselected = d.district || d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

				for (var i = 0; i < data.length; i++)
				{
					if (data[i].CY_district == areaselected)
					{							
						areaorigin[n] = data[i].district_org_source;
						n = n + 1;
						//break;
					}
				}
				
				//get unique data
				var unique_areaorigin = areaorigin.filter(function(item, pos) 
				{					
					return areaorigin.indexOf(item) == pos;
				});	 
                return unique_areaorigin; 
					
			}
			
			var getDestCity = function (d,type) 
            {
				var areadest = [];
				var areasd = [];
				var arealbm = [];
				var n = 0;
				var areaselected = d.district || d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

				for (var i = 0; i < data.length; i++)
				{
					if (data[i].district_org_source == areaselected)
					{							
						areadest[n] = data[i].CY_district;
						areasd[n] = data[i].CY_subdistrict;
						arealbm[n] = data[i].cy_id_new;
						n = n + 1;
						//break;
					}
				}
				
				//get unique data
				var unique_areadest = areadest.filter(function(item, pos) 
				{					
					return areadest.indexOf(item) == pos;
				});	
				
				var unique_areasd = areasd.filter(function(item, pos) 
				{					
					return areasd.indexOf(item) == pos;
				});
				
				var unique_arealbm = arealbm.filter(function(item, pos) 
				{					
					return arealbm.indexOf(item) == pos;
				}); 
				if (type == "district"){return unique_areadest;} 
				if (type == "subdistrict"){return unique_areasd;}
				if (type == "lbm"){return unique_arealbm;}               
                 
					
			}
			
			var getDistrictBasedOnMarketCode = function (d) 
            {
				var dist = [];
				var n = 0;
				var lbmCodeSelected = d.marketCode;

				for (var i = 0; i < data.length; i++)
				{
					if (data[i].cy_id_new == lbmCodeSelected)
					{							
						dist[n] = data[i].CY_district;
						d.district = data[i].CY_district;
						n = n + 1;
						//break;
					}
				}          
                return d; 
					
			}
			
			
			//function to print weekly volume information of the origin areas based on selected destination
			var getInfoOrifromDest = function (d,selected) 
            {
				areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;
				
				//return data with selected origin selection
				var databasedondest = data.filter(function(d)
					{
						return d.CY_district == areaselected;
					})
				
				var datafilterbydistrictandspecies = d3.nest()
					.key(function(d){ return d.district_org_source })
					.key(function(d){ return d.species })
					.rollup(function(d)
						{
							return d3.sum(d, function (g){ return g.weekly_volume});
						})
					.entries(databasedondest)
				datamovjak=datafilterbydistrictandspecies;
					
			}
			
			var getInfoDestfromOri = function (d,selected) 
            {
				if (selected == "district")
				{
					areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;
				
					//return data with selected origin selection
					var databasedonorigin = data.filter(function(d)
						{
							return d.district_org_source == areaselected;
						})
				
					var datafilterbydistrictandspecies = d3.nest()
						.key(function(d){ return d.CY_district })
						.key(function(d){ return d.species })
						.rollup(function(d)
							{
								return d3.sum(d, function (g){ return g.weekly_volume});
							})
						.entries(databasedonorigin)
					datamovjav=datafilterbydistrictandspecies;	
				
//console.log(datamovjav)
				}
				else if (selected == "subdistrict")
				{
//console.log(d)
					areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;
				
					//return data with selected origin selection
					var databasedonorigin = data.filter(function(d)
						{
							return d.district_org_source == areaselected;
						})
				
					var datafilterbydistrictandspecies = d3.nest()
						.key(function(d){ return d.CY_subdistrict })
						.key(function(d){ return d.species })
						.rollup(function(d)
							{
								return d3.sum(d, function (g){ return g.weekly_volume});
							})
						.entries(databasedonorigin)
					datamovjavSD=datafilterbydistrictandspecies;	
				
//console.log(datamovjavSD)
				}
				else if (selected == "lbm")
				{
//console.log(d)
					areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;
				
					//return data with selected origin selection
					var databasedonorigin = data.filter(function(d)
						{
							return d.district_org_source == areaselected;
						})
				
					var datafilterbydistrictandspecies = d3.nest()
						.key(function(d){ return d.cy_id_new })
						.key(function(d){ return d.species })
						.rollup(function(d)
							{
								return d3.sum(d, function (g){ return g.weekly_volume});
							})
						.entries(databasedonorigin)
					datamovjavLBM=datafilterbydistrictandspecies;	
				
//console.log(datamovjavLBM)
				}		

			}
			
			var dt = function(dest,ori) 
			{

				var result = [];
				var n = 0;
				for (var i = 0; i < ori.length; i++)
				{

					 var dataState = ori[i];
					 //Find the corresponding state inside the GeoJSON
					for (var j = 0; j < dest.features.length; j++)
					{
						var jsonState = dest.features[j].properties.KAB_KOTA;
						if (dataState == jsonState ) {
							result[n] = dest.features[j];
							n = n + 1;
							break;
						}
					}
				}
				return result
			}; 


/******************************** F U N C T I O N S ********************************/				
			function getcsvdata()
			{
				//Get data from CSV file
				//The d3.csv() function does both the loading and the parsing without giving you a chance to intervene so we need to do this
				d3.xhr('Movement.csv').get(function (err, response) 
				{
					// to delete the first row and get the header
					var dirtyCSV = response.responseText;
					var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
					data = d3.csv.parse(cleanCSV);
				})
			}
		
			function updateMapJKT(js) 
			{
				if(map.selectAll("path").empty()) {
                    gjkt.append("g")
                    	.selectAll("path")
						.data(js.features)
						.enter()
						.append("path")
						.attr("d", path)
						.style("fill", setNormalColor)
						.style("stroke", "rgb(0,109,44)")
						.on("click", function(d)
						{
							//replacement moveout
							d3.select(this).style("fill", setNormalColor(d));
							d3.select("#tooltip").classed("hidden", true);	//hide
							
							//remove selection on Java Map
							map2.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							
							//remove selection on Java Map
							map.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							
							d3.select("table").remove();
							//end moveout

							d3.select(this)
									.style("fill", "orange");

							var coordinates = [0, 0];
								coordinates = d3.mouse(this);
	
							var target = d3.select("#tooltip")
									.style("left", leftbuble+"px")//coordinates[0] + "px")
									.style("top", topbuble+"px")//coordinates[1] + "px")
									.style("width", widthbuble+"px")
									.style("height", heightbuble+"px");
								target.select("#daerah")
									.text("DESTINATION :"+d.properties.KAB_KOTA);
							
							//Show tooltip
							d3.select("#tooltip").classed("hidden", false);
							
/************************** generate table info *****************************************/
							getInfoOrifromDest(d,"district")
							//var JakTable = tabulate(datamovjak, ["species","district_org_source",  "tot"]);
							var datamovjakconvert = DataConverter2(datamovjak,"dest_to_ori","district");	
							var datamovjakconvertaddtot = addTotalField(datamovjakconvert);
							var totalreceive = addTotalSendOrReceive(datamovjakconvert);
							target.select("#info").text("Total weekly from All Origins (detail below) : "+totalreceive+" species");
							var JakTable = tabulate2(datamovjakconvertaddtot);
							
							if(d3.select("#legendJKT").empty()) {legendinJak();}
							if(d3.select("#legendJKTR").empty()) {legendRepJak();}
							if(d3.select("#legendJV").empty()) {legendinJava();}
							if(d3.select("#legendJVR").empty()) {legendRepJava();}
							d3.select("#legendJKT").classed("hidden", true);
							d3.select("#legendJKTR").classed("hidden", false);
							d3.select("#legendJV").classed("hidden", false);
							d3.select("#legendJVR").classed("hidden", true);
							d3.select("#ljkt1R").text(totalreceive+" species");
							
							
							minmaxvaljv = getMaxTot(datamovjakconvertaddtot)
							deviderLegend(minmaxvaljv,"JV")
							
							//get the origin cities based on selected destination
							var oricity = getOriginCity(d);
							
							
							//generate all selected origin city on Java Map
							dt_res = dt(javjson,oricity);

							//added total value to the data
							for (var i = 0; i < dt_res.length; i++)
							{
								for (var j = 0; j < datamovjakconvertaddtot.length; j++)
								{
									if (dt_res[i].properties.KAB_KOTA == datamovjakconvertaddtot[j].ori)
									{
										dt_res[i].properties.total = datamovjakconvertaddtot[j].total
									}
								}
							} 
							map2.selectAll("path")
								.data(dt_res, function(d) { 
									return d.properties.OBJECTID; })
								.style("fill", setJavColor)//"orange")//color(js.properties.value))
								.attr("stroke-width", 2);
							//end of generation
								
						})
						.on("dblclick", function(d){clicked(d,jktw,jkth,gjkt, path, projection, zoom)});	
					
				} else {
					map.selectAll("path")
						//.attr("fill", "none")
						.style("fill", setJktColor)
						.attr("stroke-width", 1);
					map.selectAll("path")
						.data([js], function(d) { return d.properties.OBJECTID; })
						.style("fill", "orange")//color(js.properties.value))
						.attr("stroke-width", 2);
				}	
			}

            function updateMapJAVA(js) 
            {
				if(map2.selectAll("path").empty()) {
                    gjw.append("g").selectAll("path")
                       .data(js.features)
                       .enter()
                       .append("path")
                       .attr("d", path2)
                       .style("fill", setNormalColor)
                       .style("stroke", "rgb(0,109,44)")
                       .on("click", function(d)
						{
							
							//replacement for moveout
							ForFilter = d3.select(this);
							DvalueForFilter = d;
							d3.select(this).style("fill", setNormalColor(d));
							d3.select("#tooltip").classed("hidden", true);
							
							//remove selection on Java Map
								map.selectAll("path")
								.style("fill", setNormalColor)
								.attr("stroke-width", 1);
								//end removal section
								
							//remove selection on Java Map
								map2.selectAll("path")
								.style("fill", setNormalColor)
								.attr("stroke-width", 1);
								//end removal section
							
							d3.select("table").remove();
							gjkt.selectAll("circle").remove();
							gjkt.selectAll("rect").remove();
							
							
/************************** generate select-self district position and Bubble text ******/									
							d3.select(this).style("fill", "purple");
//console.log(d3.select(this))
							var target = d3.select("#tooltip")
								.style("left", leftbuble+"px")
								.style("top", topbuble+"px")
								.style("width", widthbuble+"px")
								.style("height", heightbuble+"px");

							target.select("#daerah").text("Origin : "+d.properties.KAB_KOTA+" - " + d.properties.PROPINSI);
							//target.select("#info").text(getInfo2(d));

							//Show tooltip
							d3.select("#tooltip").classed("hidden", false);
							
/************************** generate table info *****************************************/
							var totalsend = 0;
							if(d3.select("#legendJKT").empty()) {legendinJak();}
							if(d3.select("#legendJKTR").empty()) {legendRepJak();}
							if(d3.select("#legendJV").empty()) {legendinJava();}
							if(d3.select("#legendJVR").empty()) {legendRepJava();}
							d3.select("#legendJKT").classed("hidden", false);
							d3.select("#legendJKTR").classed("hidden", true);
							d3.select("#legendJV").classed("hidden", true);
							d3.select("#legendJVR").classed("hidden", false);
							
							if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
							{
								getInfoDestfromOri(d,"district");
								var datamovjavconvert = DataConverter2(datamovjav,"ori_to_dest","district");	
								var datamovjavconvertaddtot = addTotalField(datamovjavconvert);
								totalsend = addTotalSendOrReceive(datamovjavconvert);
								target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
								d3.select("#ljv1R").text(totalsend+" species");
								var JavTable = tabulate2(datamovjavconvertaddtot);
								minmaxvaljkt = getMaxTot(datamovjavconvertaddtot);
								deviderLegend(minmaxvaljkt,"JKT")
								
								getInfoDestfromOri(d,"subdistrict");
								var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
								var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
								
								getInfoDestfromOri(d,"lbm");
								var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
								var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
							}
							else if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "SD+LBM" )
							{
								getInfoDestfromOri(d,"subdistrict");
								var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
								var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
								totalsend = addTotalSendOrReceive(datamovjavconvertSD);
								target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
								d3.select("#ljv1R").text(totalsend+" species");
								var JavTable = tabulate2(datamovjavconvertaddtotSD);
								minmaxvaljkt = getMaxTot(datamovjavconvertaddtotSD);
								deviderLegend(minmaxvaljkt,"JKT")
								
								getInfoDestfromOri(d,"lbm");
								var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
								var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
							}
							else if (destinationmenu == "LBM")
							{
								getInfoDestfromOri(d,"lbm");
								var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
								var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
								
	
								//convert cy_id_new into LBM name
								d3.csv("dest2lbm.csv", function(lbms)
								{
									var dt_lbm = [];
									var n = 0;
									for (var i = 0; i < lbms.length; i++)
									{
										for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
										{	
							
											if(lbms[i].marketCode == datamovjavconvertaddtotLBM[j].dest)
											{	
												dt_lbm[n] = datamovjavconvertaddtotLBM[j];
												dt_lbm[n].dest = lbms[i].name
												n = n + 1;
											}
										}
									}
									var JavTable = tabulate2(dt_lbm);
									minmaxvaljkt = getMaxTot(dt_lbm);
									deviderLegend(minmaxvaljkt,"JKT")
									totalsendLBM = addTotalSendOrReceive(dt_lbm);
									target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendLBM+" species");
									d3.select("#ljv1R").text(totalsendLBM+" species");
									
					
								})
							}
							

/************************** generate position district on JKT MAP **********************************/
							if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
							{
								//get the origin cities based on selected destination
								var destcity = getDestCity(d, "district");
								var dt = function(ori, dest) 
								{

									var result = [];
									var n = 0;
									for (var i = 0; i < dest.length; i++)
									{

										 var dataState = dest[i];
										 //Find the corresponding state inside the GeoJSON
										for (var j = 0; j < ori.features.length; j++)
										{
											var jsonState = ori.features[j].properties.KAB_KOTA;
											if (dataState == jsonState ) {
												result[n] = ori.features[j];
												n = n + 1;
												break;
											}
										}
									}
									return result
								}; 
								var dataselectedD = dt(jakjson, destcity); 

								for (var i = 0; i < dataselectedD.length; i++)
								{
									for (var j = 0; j < datamovjavconvertaddtot.length; j++)
									{
										if (dataselectedD[i].properties.KAB_KOTA == datamovjavconvertaddtot[j].dest)
										{
											dataselectedD[i].properties.total = datamovjavconvertaddtot[j].total
										}
									}
								}
								map.selectAll("path")
									.data(dataselectedD, function(d) { return d.properties.OBJECTID; })
									.style("fill", setJktColor)//"purple")//color(js.properties.value))
									.attr("stroke-width", 2);
							}
							
/************************** generate position subdistrict *******************************/
							if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "D+SD" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
							{
								var destsd = getDestCity(d, "subdistrict");

								var dtsd = function(datassd) 
								{

									d3.csv("dest1dki.csv", function(sds)
									{
										var result = [];
										var n = 0;
										var possd = [];
										for (var i = 0; i < datassd.length; i++)
										{

											 var dataState = datassd[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < sds.length; j++)
											{
												var jsonState = sds[j].subdistrict;
												if (dataState == jsonState ) {
													result[n] = sds[j];
													var Lat = (-1*sds[j].gps_north_degree) - (+sds[j].gps_north_minute/100),
													Long = (1*sds[j].gps_east_degree) + (+sds[j].gps_east_minute/100),
													location = [+Long, +Lat];
													sds[j].location = location;
													possd.push(projection(location));
													n = n + 1;
													break;
												}
											}
										}
										var g = gjkt.selectAll("g")
										.data(result)
										//.enter()
										.append("svg:g");
					

										for (var i = 0; i < result.length; i++)
										{
											for (var j = 0; j < datamovjavconvertaddtotSD.length; j++)
											{
												if (result[i].subdistrict == datamovjavconvertaddtotSD[j].dest)
												{
													result[i].total = datamovjavconvertaddtotSD[j].total
												}
											}
										}
										
										//generate the circles
										showCity(result,gjkt,possd,setJktColorSDLBM, "circle");
									
										gjkt.selectAll("circle")
										.on("click", function(d) 
										{

											// replacement for moveout
											d3.select("#tooltip").classed("hidden", true);
											//remove selection on Java Map
											map2.selectAll("path")
											.style("fill", setNormalColor)
											.attr("stroke-width", 1);
											//end removal section
											
											map.selectAll("path")
											.style("fill", setNormalColor)
											.attr("stroke-width", 1);
											//end removal section
											// end moveout
											
											var target = d3.select("#tooltip")
													.style("left", leftbuble+"px")
													.style("top", topbuble+"px")
													.style("width", widthbuble+"px")
													.style("height", heightbuble+"px");
												target.select("#daerah")
													.text("DEST Subdistrict :"+d.subdistrict);

												target.select("#info")
													.text("location: " + d.location );
															
							
											//Show tooltip
											d3.select("#tooltip").classed("hidden", false);
							
							
											//get the origin cities based on selected destination
											var oricity = getOriginCity(d);
											
											var dt = function(ori, dest) 
											{

												var result = [];
												var n = 0;
												for (var i = 0; i < dest.length; i++)
												{

													 var dataState = dest[i];
													 //Find the corresponding state inside the GeoJSON
													for (var j = 0; j < ori.features.length; j++)
													{
														var jsonState = ori.features[j].properties.KAB_KOTA;
														if (dataState == jsonState ) {
															result[n] = ori.features[j];
															n = n + 1;
															break;
														}
													}
												}
												return result
											}; 
											//generate all selected origin city on Java Map
											dt_res = dt(javjson,oricity); 
											map2.selectAll("path")
												.data(dt_res, function(d) { 
													return d.properties.OBJECTID; })
												.style("fill", "blue")//color(js.properties.value))
												.attr("stroke-width", 2);
											//end of generation
							 
										})
									})
								
								};
								var dataselectedsd = dtsd(destsd);
							}
/************************** generate position LBM ***************************************/
							if (destinationmenu == "LBM" || destinationmenu == "D+LBM" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
							{
								var destlbm = getDestCity(d, "lbm");
								var dtlbm = function(dataslbm) 
								{

									d3.csv("dest2lbm.csv", function(lbms)
									{
										var result = [];
										var n = 0;
										var poslbm = [];
										for (var i = 0; i < dataslbm.length; i++)
										{

											 var dataState = dataslbm[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < lbms.length; j++)
											{
												var jsonState = lbms[j].marketCode;
												if (dataState == jsonState ) {
													result[n] = lbms[j];
													var Lat = (-1*lbms[j].LS_Coord_Deg) - (+lbms[j].LS_Coord_Min/100),
														Long = (1*lbms[j].BT_Coord_Deg) + (+lbms[j].BT_Coord_Min/100),
													location = [+Long, +Lat];
													lbms[j].location = location;
													poslbm.push(projection(location));
													n = n + 1;
													break;
												}
											}
										}
										var g = gjkt.selectAll("g")
										.data(result)
										//.enter()
										.append("svg:g");
					
										for (var i = 0; i < result.length; i++)
										{
											for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
											{
												if (result[i].name == datamovjavconvertaddtotLBM[j].dest)
												{
													result[i].total = datamovjavconvertaddtotLBM[j].total
												}
											}
										}

										//generate the circles
										showCity(result,gjkt,poslbm,setJktColorSDLBM, "rect");
									
										gjkt.selectAll("rect")
										.on("click", function(d) 
										{
											//replacement for moveout
											d3.select("#tooltip").classed("hidden", true);
											//remove selection on Java Map
											map2.selectAll("path")
											.style("fill", setNormalColor)
											.attr("stroke-width", 1);
											//end removal section
											
											//remove selection on Java Map
											map.selectAll("path")
											.style("fill", setNormalColor)
											.attr("stroke-width", 1);
											//end removal section
											//end moveout
											
											var target = d3.select("#tooltip")
													.style("left", leftbuble+"px")//coordinates[0] + "px")
													.style("top", topbuble+"px")//coordinates[1] + "px")
													.style("width", widthbuble+"px")
													.style("height", heightbuble+"px");
												target.select("#daerah")
													.text("DEST LBM :"+d.name);

												target.select("#info")
													.text("location: " + d.location );
															
							
											//Show tooltip
											d3.select("#tooltip").classed("hidden", false);
							
											//get the origin cities based on selected destination
											var selecteddata = getDistrictBasedOnMarketCode(d);
											var oricity = getOriginCity(selecteddata);
											
											var dt = function(ori, dest) 
											{

												var result = [];
												var n = 0;
												for (var i = 0; i < dest.length; i++)
												{

													 var dataState = dest[i];
													 //Find the corresponding state inside the GeoJSON
													for (var j = 0; j < ori.features.length; j++)
													{
														var jsonState = ori.features[j].properties.KAB_KOTA;
														if (dataState == jsonState ) {
															result[n] = ori.features[j];
															n = n + 1;
															break;
														}
													}
												}
												return result
											}; 
											//generate all selected origin city on Java Map
											dt_res = dt(javjson,oricity); 
											map2.selectAll("path")
												.data(dt_res, function(d) { 
													return d.properties.OBJECTID; })
												.style("fill", "red")//color(js.properties.value))
												.attr("stroke-width", 2);
											//end of generation
										})
									})
								
								};
								var dataselectedlbm = dtlbm(destlbm);
							}
						})
                        .on("dblclick", function(d){clicked(d,jww,jwh,gjw, path2, projection2, zoom2)});;
					
				} else {
					map2.selectAll("path")
						//.attr("fill", "none")
						.style("fill", setNormalColor)
						.attr("stroke-width", 1);
					map2.selectAll("path")
						.data([js[0]], function(d) { 
							return d.properties.OBJECTID; })
						.style("fill", "orange")//color(js.properties.value))
						.attr("stroke-width", 2);
				}	
			} 
			            
            function clicked(d,w,h, gpath, p, proj, z) 
            {
				var centroid = p.centroid(d),
				  translate = proj.translate();

				proj.translate([
				translate[0] - centroid[0] + w / 2,
				translate[1] - centroid[1] + h / 2
				]);

				z.translate(proj.translate());

				gpath.selectAll("path").transition()
				  .duration(700)
				  .attr("d", p);
				
				gpath.selectAll("circle")
					.transition()
				  	.duration(700)
					.attr("transform", function(d,i)
					{

						return "translate("+proj.translate()+" )"
					})
					
				gpath.selectAll("rect")
					.transition()
				  	.duration(700)
					.attr("transform", function(d,i)
					{

						return "translate("+proj.translate()+" )"
					})
				
				/*gpath.selectAll("text")
					.transition()
				  	.duration(700)
					.attr("transform", function(d,i)
					{

						return "translate("+proj.translate()+" )"
					})*/
			}

			//zoom function for jkt
			function zoomed() 
			{		
				gjkt.attr("transform","translate("+ 
						d3.event.translate.join(",")+")scale("+d3.event.scale+")");
				gjkt.selectAll("circle")
					.attr("d", path.projection(projection))
					.attr("r", 5/zoom.scale())
					.attr("stroke-width", function()
					{	
						if (zoom.scale()>4){return 0;}
						else {return 1}
					});
				gjkt.selectAll("rect")
					.attr("d", path.projection(projection))
					.attr("width", 10/zoom.scale())
					.attr("height", 10/zoom.scale())
					.attr("stroke-width", function()
					{	
						if (zoom.scale()>4){return 0;}
						else {return 1}
					});
				gjkt.selectAll("path")  
					.attr("d", path.projection(projection));
				/*gjkt.selectAll("text")  
					.attr("d", path.projection(projection)); */
				
				
			}
			
			//zoom function for Java
			function zoomed2() 
			{
				gjw.attr("transform","translate("+ 
						d3.event.translate.join(",")+")scale("+d3.event.scale+")");
				gjw.selectAll("circle")
					.attr("d", path2.projection(projection2))
					.attr("r", 5/zoom.scale());
				gjw.selectAll("rect")
					.attr("d", path2.projection(projection2))
					.attr("width", 10/zoom.scale())
					.attr("height", 10/zoom.scale());
				gjw.selectAll("path")  
					.attr("d", path2.projection(projection2));
				/*gjw.selectAll("text")  
					.attr("d", path2.projection(projection2));*/
			}
            
            //generate the circles
            function showCity(cities, whmap, pt, color, type)
			{		
				/* Define the data for the circles */
				var elem = whmap.selectAll(type)
								.data(cities)

				/*Create and place the "blocks" containing the circle and the text */  
				var elemEnter = elem.enter()
					.append("g")
					.attr("transform", function(d,i)
					{

						return "translate("+pt[i][0]+","+pt[i][1]+" )"
					})			
			
				if (type == "circle")
				{
					/*Create the circle for each block */
					var circle = elemEnter.append("circle")
										.style("stroke", "gray")
										.attr("stroke-width", 1)
										.style("fill", color)
										.attr("r", 5)//function(d, i) { return Math.sqrt(countByCity[d.Name]); })
										//.sort(function(a, b) { return countByCity[b.Name] - countByCity[a.Name]; })
										pt = [];
				}
										
				if (type == "rect")
				{
				/*Create the rect for each block */
				
					var rect = elemEnter.append("rect")
										.style("stroke", "gray")
										.attr("stroke-width", 1)
										.style("fill", color)
										.attr("height", 10)
										.attr("width", 10)//function(d, i) { return Math.sqrt(countByCity[d.Name]); })
										//.sort(function(a, b) { return countByCity[b.Name] - countByCity[a.Name]; })
										pt = [];
				}
				

				/* Create the text for each block */
				/*elemEnter.append("text")
						.text(function(d){
							return d.subdistrict;})
						.attr("dx", function(d){return 0})
						.attr("dy", function(d){return 20})
						.attr({
							  "alignment-baseline": "middle",
							  "text-anchor": "middle"
							})*/
				
			}
			
			//show circles of lbm positions (on JKT Map: Color Red Circles) 
			function lbmextraction(proj, shape, citycolor)
			{
				
				var poslbm = [];
				var arc = d3.geo.greatArc()
					  .source(function(d) { return locationByCity[d.source]; })
					  .target(function(d) { return locationByCity[d.target]; });

				data.forEach(function(deliver) 
				{
					var origin = deliver.district_org_source,
						destination = deliver.cy_id_new,
						links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
						
					links.push({source: origin, target: destination});
					countByCity[origin] = (countByCity[origin] || 0) + 1;
					countByCity[destination] = (countByCity[destination] || 0) + 1;
				});
				
				d3.csv("dest2lbm.csv", function(lbms) 
				{
					
					lbms = lbms.filter(function(lbm) 
					{						
						if (countByCity[lbm.marketCode]) 
						{
							var Lat = (-1*lbm.LS_Coord_Deg) - (+lbm.LS_Coord_Min/100),
							Long = (1*lbm.BT_Coord_Deg) + (+lbm.BT_Coord_Min/100),
							locationlbm = [+Long, +Lat];
							lbm.location = locationlbm
							locationByCity[lbm.name] = locationlbm;
							poslbm.push(proj(locationlbm));

							return true;
						}
						
					});
				
					var g = shape.selectAll("g")
						.data(lbms)
						//.enter()
						.append("svg:g");
					
					//generate the circles
					showCity(lbms,shape,poslbm,citycolor,"rect");
					
					shape.selectAll("rect")
						.on("click", function(d) 
						{
							//replacement for moveout
							d3.select("#tooltip").classed("hidden", true);
							//remove selection on Java Map
							map2.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							
							//remove selection on Java Map
							map.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							// end moveout
							
							var coordinates = [0, 0];
								coordinates = d3.mouse(this);
							var target = d3.select("#tooltip")
									.style("left", leftbuble+"px")//coordinates[0] + "px")
									.style("top", topbuble+"px")//coordinates[1] + "px")
									.style("width", widthbuble+"px")
									.style("height", heightbuble+"px");
								target.select("#daerah")
									.text("DEST LBM :"+d.name);

								target.select("#info")
									.text("location: " + d.location );
															
							
							//Show tooltip
							d3.select("#tooltip").classed("hidden", false);
							
							//get the origin cities based on selected destination
							var selecteddata = getDistrictBasedOnMarketCode(d);
							var oricity = getOriginCity(selecteddata);
							
							
							//generate all selected origin city on Java Map
							dt_res = dt(javjson,oricity); 
							map2.selectAll("path")
								.data(dt_res, function(d) { 
									return d.properties.OBJECTID; })
								.style("fill", "red")//color(js.properties.value))
								.attr("stroke-width", 2);
							//end of generation
						})
				});	
			};
			
			//show circles of subdistrict positions (on JKT Map: Color Blue Circles)
			function subdistrictextraction(proj, shape, citycolor)
			{
				var possd=[];
				var arc = d3.geo.greatArc()
					  .source(function(d) { return locationByCity[d.source]; })
					  .target(function(d) { return locationByCity[d.target]; });

				data.forEach(function(deliver) 
				{
					var origin = deliver.district_org_source,
						destination = deliver.CY_subdistrict,
						links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
						
					links.push({source: origin, target: destination});
					countByCity[origin] = (countByCity[origin] || 0) + 1;
					countByCity[destination] = (countByCity[destination] || 0) + 1;
				});
			
				d3.csv("dest1dki.csv", function(sds) 
				{
					// Only consider cities with at least one deliver.
					sds = sds.filter(function(sd) 
					{
			
						if (countByCity[sd.subdistrict]) 
						{
							var Lat = (-1*sd.gps_north_degree) - (+sd.gps_north_minute/100),
							Long = (1*sd.gps_east_degree) + (+sd.gps_east_minute/100),
							location = [+Long, +Lat];
							sd.location = location;
							locationByCity[sd.subdistrict] = location;
							possd.push(proj(location));
							return true;
						}
					});
				
					var g = shape.selectAll("g")
						.data(sds)
						//.enter()
						.append("svg:g");
					

					//generate the circles
					showCity(sds,shape,possd,citycolor, "circle");
					
				
					shape.selectAll("circle")
						.on("click", function(d) 
						{
							//replacement for moveout
							d3.select("#tooltip").classed("hidden", true);
							//remove selection on Java Map
							map2.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							
							//remove selection on Java Map
							map.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
							//end moveout
							
							
							var target = d3.select("#tooltip")
									.style("left", leftbuble+"px")
									.style("top", topbuble+"px")
									.style("width", widthbuble+"px")
									.style("height", heightbuble+"px");
								target.select("#daerah")
									.text("DEST Subdistrict :"+d.subdistrict);

								target.select("#info")
									.text("location: " + d.location );
															
							
							//Show tooltip
							d3.select("#tooltip").classed("hidden", false);
							
							
							//get the origin cities based on selected destination
							var oricity = getOriginCity(d);
							
							
							//generate all selected origin city on Java Map
							dt_res = dt(javjson,oricity); 
							map2.selectAll("path")
								.data(dt_res, function(d) { 
									return d.properties.OBJECTID; })
								.style("fill", "blue")//color(js.properties.value))
								.attr("stroke-width", 2);
							//end of generation 
						})
					});	
			};
			
			//show circles of district positions (on JKT Map: Color Blue Circles)	
			function districtextraction(datajson, pos, proj, shape, citycolor)
			{
				var arc = d3.geo.greatArc()
					  .source(function(d) { return locationByCity[d.source]; })
					  .target(function(d) { return locationByCity[d.target]; });

				//call data (variable global) to get data from movement.csv
				data.forEach(function(deliver) 
				{
					var origin = deliver.district_org_source,
						destination = deliver.CY_district,
						links = linksByOrigin[origin] || (linksByOrigin[origin] = []);
						
					links.push({source: origin, target: destination});
					countByCity[origin] = (countByCity[origin] || 0) + 1;
					countByCity[destination] = (countByCity[destination] || 0) + 1;
				});
			
				d3.csv("indonesia_java.csv", function(cities) 
				{
					// Only consider cities with at least one deliver.
					cities = cities.filter(function(city) 
					{
						if (countByCity[city.Name]) 
						{
							var location = [+city.Longitude, +city.Latitude];
							locationByCity[city.Name] = location;
							pos.push(proj(location));
							return true;
						}
					});
				

					var g = map.selectAll("g")
						.data(cities)
						//.enter()
						.append("svg:g");
					
					//generate the circles
					showCity(cities,shape,pos,citycolor);
					
					shape.selectAll("circle")
						.on("click", function(d) 
						{
							//replacement for moveout
							//generate the circles
							d3.json("indonesia_districts_java_only.json", function(json) 
							{
								circles2.selectAll("circle").remove();
								//districtextraction(json, positions2, projection2, circles2, "orange");
							});
							//end moveout
							
							getOriginCity(d);
							
							d3.csv("indonesia_java.csv", function(cities) 
							{
								cities = cities.filter(function(city) 
								{

									  if (unique_areatarget.indexOf(city.Name)!=-1) 
									  {

										var location = [+city.Longitude, +city.Latitude];
										locationByCity[city.Name] = location;
										positions2.push(projection2(location));
										return true;
									  }
								});
								
								var g = map2.selectAll("g")
										.data(cities)
										//.enter()
										.append("svg:g");
					
				
									//generate the circles
									d3.json("indonesia_districts_java_only.json", function(json) 
									{
										circles2.selectAll("circle").remove();
										//drawthecity(cities, circles2, positions2, "blue")
										//districtextraction(json, positions2, projection2, circles2, "blue");
										//showCity(cities, circles2, positions2, "blue")
									});
							}); 
						})
					});	
			};
			
			// The table generation function for non-nested table 
			function tabulate(data, columns) 
			{
				var table = clist.append("foreignObject")
					.attr("x", width - 4*margin - 250)
					.attr("y", 4*margin)
					.attr("width", 250)
					.attr("height",height-5*margin)
				.append("xhtml:body")
						.append("table")
						.attr("class", "tblinfo")
						.attr("style", "margin-left: 0px"),
					thead = table.append("thead"),
					tbody = table.append("tbody");

				// append the header row
				thead.append("tr")
					.selectAll("th")
					.data(columns)
					.enter()
					.append("th")
						.text(function(column) 
						{ 
							if (column == "CY_district"){column = "Area Destination"}
							if (column == "district_org_source"){column = "Area Origin"}
							if (column == "tot"){column = "Total Weekly Volume"}
							if (column == "species"){column = "Bird Species"}
						
							return column; 
						});

				// create a row for each object in the data
				var rows = tbody.selectAll("tr")
					.data(data)
					.enter()
					.append("tr");

				// create a cell in each row for each column
				var cells = rows.selectAll("td")
					.data(function(row) {
						return columns.map(function(column) {
							return {column: column, value: row[column]};
						});
					})
					.enter()
					.append("td")
					.attr("style", "font-family: Courier") // sets the font style
						.html(function(d) { return d.value; });
	
				return table;
			}
						
			// The table generation function foe nested tabel
			function tabulate2(data) 
			{
				var table = clist.append("foreignObject")
								.attr("x", width - 3*margin - 250)
								.attr("y", 10*margin)
								.attr("width", 250)
								.attr("height",height-5*margin)
								.append("xhtml:body")
								.append("div")
								.attr("class", "outer")
								.append("div")
								.attr("class", "inner")
								.append("div")
								.attr("id", "InfoTab")
								.selectAll("table")
								.data([data])
								.enter().append("table")
								.call(recurse);
				return table;
			}
			
			//added title and other information for the interfaces
			function titleinterface()
			{
				svg.append("svg:text")
					.classed("title", true)
					.attr("text-anchor", "start")
					.attr("x", 1.5*margin)
					.attr("y", 1*margin)
					.text("Weekly Volume Distribution of Birds into JABODETABEK ");
				svg.append("svg:text")
					.attr("text-anchor", "start")
					.attr("y", height-5)
					.text("Spreading birds data 2015");
				svg.append("svg:text")
					.attr("text-anchor", "end")
					.attr("x", width)
					.attr("y", height-5)
					.text("@Urremote.com 2015");
			}
			
			//create legend bar 
			function legendinJava()
			{			
				var legendjv = clist.append("g").attr("id", "legendJV")
				legendjv.append("svg:rect")
					.attr("id", "ljvb5")
					.attr("fill", "#FF0000")
					.attr("x", margin)
					.attr("y", jkth+jwh-6*marginforlegend-8)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjv.append("svg:rect")
					.attr("id", "ljvb4")
					.attr("fill", "#FF7D7D")
					.attr("x", margin)
					.attr("y", jkth+jwh-5*marginforlegend-6)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjv.append("svg:rect")
					.attr("id", "ljvb3")
					.attr("fill", "#FFC400")
					.attr("x", margin)
					.attr("y", jkth+jwh-4*marginforlegend-4)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjv.append("svg:rect")
					.attr("id", "ljvb2")
					.attr("fill", "#FCDF7E")
					.attr("x", margin)
					.attr("y", jkth+jwh-3*marginforlegend-2)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjv.append("svg:rect")
					.attr("id", "ljvb1")
					.attr("fill", "#FFFFFF")
					.attr("x", margin)
					.attr("y", jkth+jwh-2*marginforlegend)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
				
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("transform", "translate("+(margin - 5)+","+(jkth+jwh-1*marginforlegend)+") rotate("+270+")")
					.text("Weekly Volume")
					
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv5")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-5*marginforlegend-10) + ")")
					.text("31 - 40")
					
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv4")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-4*marginforlegend-6) + ")")
					.text("21 - 30")
					
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv3")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-3*marginforlegend-4) + ")")
					.text("11 - 20")
					
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv2")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-2*marginforlegend-2) + ")")
					.text("1 - 10")
					
				legendjv.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv1")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-marginforlegend) + ")")
					.text("0")
			}
			
			function legendRepJava()
			{			
				var legendjvR = clist.append("g").attr("id", "legendJVR")
					
				legendjvR.append("svg:rect")
					.attr("fill", "purple")
					.attr("x", margin)
					.attr("y", jkth+jwh-2*marginforlegend)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
				
				legendjvR.append("svg:text")
					.classed("expl", true)
					.attr("transform", "translate("+(margin - 5)+","+(jkth+jwh-1*marginforlegend)+") rotate("+270+")")
					.text("Origin Selected")
					
				legendjvR.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljv1R")
					.attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-marginforlegend) + ")")
					
			}
			
			function legendinJak()
			{			
				var legendjkt = clist.append("g").attr("id", "legendJKT")
				legendjkt.append("svg:rect")
					.attr("id", "ljktb5")
					.attr("fill", "#0015FF")
					.attr("x", jktx+margin)
					.attr("y", jkth-5*marginforlegend-15)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjkt.append("svg:rect")
					.attr("id", "ljktb4")
					.attr("fill", "#828CFF")
					.attr("x", jktx+margin)
					.attr("y", jkth-4*marginforlegend-13)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjkt.append("svg:rect")
					.attr("id", "ljktb3")
					.attr("fill", "#00FF1E")
					.attr("x", jktx+margin)
					.attr("y", jkth-3*marginforlegend-11)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjkt.append("svg:rect")
					.attr("id", "ljktb2")
					.attr("fill", "#D1FFD5")
					.attr("x", jktx+margin)
					.attr("y", jkth-2*marginforlegend-9)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
					
				legendjkt.append("svg:rect")
					.attr("id", "ljktb1")
					.attr("fill", "#FFFFFF")
					.attr("x", jktx+margin)
					.attr("y", jkth-1*marginforlegend-7)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
				
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("transform", "translate("+(jktx+margin - 5)+","+(jkth-7)+") rotate("+270+")")
					.text("Weekly Volume")
					
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt5")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-4*marginforlegend-16) + ")")
					.text("31 - 40")
					
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt4")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-3*marginforlegend-12) + ")")
					.text("21 - 30")
					
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt3")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-2*marginforlegend-10) + ")")
					.text("11 - 20")
					
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt2")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-1*marginforlegend-8) + ")")
					.text("1 - 10")
					
				legendjkt.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt1")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-7) + ")")
					.text("0")	
			
			}
			
			function legendRepJak()
			{			
				var legendjktR = clist.append("g").attr("id", "legendJKTR")
					
				legendjktR.append("svg:rect")
					.attr("fill", "orange")
					.attr("x", jktx+margin)
					.attr("y", jkth-1*marginforlegend-7)
					.attr("width", marginforlegend)
					.attr("height", marginforlegend);//height - h2 - 5*margin);
				
				legendjktR.append("svg:text")
					.classed("expl", true)
					.attr("transform", "translate("+(jktx+margin - 5)+","+(jkth-7)+") rotate("+270+")")
					.text("Destination Selected")
					
				legendjktR.append("svg:text")
					.classed("expl", true)
					.attr("id", "ljkt1R")
					.attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (jkth-7) + ")")
					
			
			}
			
			//load filter options
			function Filter1_Origins()
			{
				var dispatch = d3.dispatch("load", "originschange");
				var dtddm1 = ["District"];

				d3.xhr("Movement.csv").get(function () 
				{
					var dtddm1ById = d3.map();
					dtddm1.forEach(function (d) 
					{ 
						dtddm1ById.set(d, d); 
					});
					dispatch.load(dtddm1ById);
					dispatch.originschange(dtddm1ById.get("District"));
				});
								
				dispatch.on("load.menu", function(dtddm1) 
				{				
					var select = svg.append("foreignObject")
							.attr("x", 1.5*margin)
							.attr("y", 2*margin)
							.attr("width", filterwidth)
							.attr("height",100)
							.append("xhtml:body")
							.append("div")
							.attr("id", "f1")
							.text("ORIGINS: ")
							.append("select")
							//.attr("multiple","multiple")
							.on("change", function () 
							{ 
								dispatch.originschange(dtddm1.get(this.value)); 
							});
							
					select.selectAll("option")
							.data(dtddm1.values())
							.enter()
							.append("option")
							.attr("value", function (d) { return d; })
							.text(function (d) 
							{ 
								return d; 
							});
							
					dispatch.on("originschange.menu", function (val) 
					{
						select.property("value", val)
						//if (typeof val != 'undefined')
						//{
							originmenu = val;
						//}
						// set new csv data based on filter from dropdownmenu1 value(ddm1value)
						datafilter(originmenu, collectormenu, destinationmenu, speciesmenu, connectionmenu)

					});
				});
				//end of drop down
			}
			
			function Filter2_Collectors()
			{
				var dispatch = d3.dispatch("load2", "collectorsschange");
				var dtddm2 = ["All Dest","District","SubDistrict","LBM"];

				d3.xhr("Movement.csv").get(function () 
				{
					var dtddm2ById = d3.map();
					dtddm2.forEach(function (d) 
					{ 
						dtddm2ById.set(d, d); 
					});
					dispatch.load2(dtddm2ById);
					dispatch.collectorsschange(dtddm2ById.get("All Dest"));
				});
								
				dispatch.on("load2.menu", function(dtddm2ById) 
				{
					var select = svg.append("foreignObject")
							.attr("x", 1.5*margin+1*filterwidth)
							.attr("y", 2*margin)
							.attr("width", filterwidth)
							.attr("height",100)
							.append("xhtml:body")
							.append("div")
							.attr("id", "f2")
							.text("COLLECT: ")
							.append("select")
							//.attr("multiple","multiple")
							.on("change", function () 
							{ 
								dispatch.collectorsschange(dtddm2ById.get(this.value)); 
							});
							
					select.selectAll("option")
							.data(dtddm2ById.values())
							.enter()
							.append("option")
							.attr("value", function (d) { return d; })
							.text(function (d) 
							{ 
								return d; 
							});
							
					dispatch.on("collectorsschange.menu", function (val) 
					{
						select.property("value", val)
						//if (typeof val != 'undefined')
						//{
							collectormenu = val;
						//}
						// set new csv data based on filter from dropdownmenu1 value(ddm1value)
						datafiltercollector(collectormenu)
						

					});
				});
				//end of drop down
			}
			
			function Filter3_Destinations()
			{
				var dispatch = d3.dispatch("load3", "destinationschange");
				var dtddm3 = ["District (D)","SubDistrict (SD)", "LBM", "D+SD", "D+LBM", "SD+LBM", "D+SD+LBM"];

				d3.xhr("Movement.csv").get(function () 
				{
					var dtddm3ById = d3.map();
					dtddm3.forEach(function (d) 
					{ 
						dtddm3ById.set(d, d); 
					});
					dispatch.load3(dtddm3ById);
					dispatch.destinationschange(dtddm3ById.get("D+SD+LBM"));
				});
								
				dispatch.on("load3.menu", function(dtddm3ById) 
				{
					var select = svg.append("foreignObject")
							.attr("x", 1.5*margin+2*filterwidth)
							.attr("y", 2*margin)
							.attr("width", filterwidth)
							.attr("height",100)
							.append("xhtml:body")
							.append("div")
							.attr("id", "f3")
							.text("DEST : ")
							.append("select")
							//.attr("multiple","multiple")
							.on("change", function () 
							{ 
								dispatch.destinationschange(dtddm3ById.get(this.value)); 
							});
							
					select.selectAll("option")
							.data(dtddm3ById.values())
							.enter()
							.append("option")
							.attr("value", function (d) { return d; })
							.text(function (d) 
							{ 
								return d; 
							});
							
					dispatch.on("destinationschange.menu", function (val) 
					{
						select.property("value", val)
						//if (typeof val != 'undefined')
						//{
							destinationmenu = val;
						//}
						// set new csv data based on filter from dropdownmenu1 value(ddm1value)
						datafilterdest(destinationmenu)
					});
				});
				//end of drop down
			}
			
			function Filter4_Species()
			{
				var dispatch = d3.dispatch("load4", "specieschange");
				//var ALL = {species:"All Species"};

				d3.xhr('Movement.csv').get(function (err, response) 
				{					
					// to delete the first row and get the header
					var dirtyCSV = response.responseText;
					var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
					data = d3.csv.parse(cleanCSV); 
					var speciesById = d3.map();
					//speciesById.set(ALL.species, ALL);
					data.forEach(function (d) 
					{ 
						speciesById.set(d.species, d); 
					});
					dispatch.load4(speciesById);
					dispatch.specieschange(speciesById.get("All Species"));

				});
								
				dispatch.on("load4.menu", function(speciesById) 
				{
					var select = svg.append("foreignObject")
							.attr("x", 1.5*margin+3*filterwidth)
							.attr("y", 2*margin)
							.attr("width", filterwidth)
							.attr("height",100)
							.append("xhtml:body")
							.append("div")
							.attr("id", "f4")
							.text("SPECIES : ")
							//.attr("style","vertical-align: top")
							.append("select")
							.attr("multiple","multiple")
							.attr("size",5) 
							//.attr("style","width: 200px")
							//.attr("style","height: 100%")
							.on("change", function () 
							{ 
								dispatch.specieschange(speciesById.get(this.value)); 
							});
							
					select.selectAll("option")
							.data(speciesById.values())
							.enter()
							.append("option")
							.attr("value", function (d) { return d.species; })
							.text(function (d) 
							{ 
								return d.species; 
							});
							
					dispatch.on("specieschange.menu", function (val) 
					{
						//select.property("value", val.species)
						speciesmenu = [];
						var spec = select
							.selectAll("option")
							.filter(function (d, i) { 
								return this.selected; 
							});
						var datelegth = spec[0].length
						if (datelegth != 0)
						{
							for (var j = 0; j < spec[0].length; j++)
							{
								speciesmenu[j] = spec[0][j]['value'];
							}
							
						}
						//console.log(speciesmenu)	


						/*
						select.selectAll("option")
							.filter(function (d, i) 
							{ 
								return this.selected; 
							});
						*/
						//if (typeof val != 'undefined')
						//{
							//speciesmenu = val.species;
						//}
						// set new csv data based on filter from dropdownmenu1 value(ddm1value)
						datafilter(originmenu, collectormenu, destinationmenu, speciesmenu, connectionmenu)
				
						

					});
				});
				//end of drop down
			}
			
			function Filter5_Connections()
			{
				var dispatch = d3.dispatch("load5", "connectionschange");
				var dtddm5 = ["Colour"];

				d3.xhr("Movement.csv").get(function () 
				{
					var dtddm5ById = d3.map();
					dtddm5.forEach(function (d) 
					{ 
						dtddm5ById.set(d, d); 
					});
					dispatch.load5(dtddm5ById);
					dispatch.connectionschange(dtddm5ById.get("Normal"));
				});
								
				dispatch.on("load5.menu", function(dtddm5ById) 
				{
					var select = svg.append("foreignObject")
							.attr("x", 1.5*margin+4*filterwidth)
							.attr("y", 2*margin)
							.attr("width", filterwidth)
							.attr("height",100)
							.append("xhtml:body")
							.append("div")
							.attr("id", "f1")
							.text("CONNECT : ")
							.append("select")
							//.attr("multiple","multiple")
							.on("change", function () 
							{ 
								dispatch.connectionschange(dtddm5ById.get(this.value)); 
							});
							
					select.selectAll("option")
							.data(dtddm5ById.values())
							.enter()
							.append("option")
							.attr("value", function (d) { return d; })
							.text(function (d) 
							{ 
								return d; 
							});
							
				
					dispatch.on("connectionschange.menu", function (val) 
					{
						select.property("value", val)
						//if (typeof val != 'undefined')
						//{
							connectionmenu = val;
						//}
						// set new csv data based on filter from dropdownmenu1 value(ddm1value)
						datafilter(originmenu, collectormenu, destinationmenu, speciesmenu, connectionmenu)
					});
				});
				//end of drop down
			}
			
			//function filter for collector
			function datafiltercollector(collector)
			{	
				d3.select("#tooltip").classed("hidden", true);
					
				//remove selection on Java Map
					map.selectAll("path")
					.style("fill", setNormalColor)
					.attr("stroke-width", 1);
					//end removal section
					
				//remove selection on Java Map
					map2.selectAll("path")
					.style("fill", setNormalColor)
					.attr("stroke-width", 1);
					//end removal section
				
				d3.select("table").remove();
				gjkt.selectAll("circle").remove();
				gjkt.selectAll("rect").remove();
				
				if (collector == "All Dest")
				{
					
					gjkt.selectAll("rect").remove();
					gjkt.selectAll("circle").remove(); 
					lbmextraction(projection, gjkt, setJktColorSDLBM)//"red")
					subdistrictextraction(projection, gjkt, setJktColorSDLBM)//"blue")
					
				}
				else if (collector == "SubDistrict")
				{
					gjkt.selectAll("circle").remove(); 
					gjkt.selectAll("rect").remove();
					subdistrictextraction(projection, gjkt, setJktColorSDLBM)//"blue")
				}
				else if (collector == "LBM")
				{
					gjkt.selectAll("circle").remove(); 
					gjkt.selectAll("rect").remove();
					lbmextraction(projection, gjkt, setJktColorSDLBM)//"red")
				}
				else
				{
					gjkt.selectAll("circle").remove(); 
					gjkt.selectAll("rect").remove();
				}
				
				
			}
			
			//function filter for destination
			function datafilterdest(destination)
			{	
				if (typeof ForFilter != 'undefined')
				{
				
					//replacement for moveout
					ForFilter.style("fill", setNormalColor(DvalueForFilter));
					d3.select("#tooltip").classed("hidden", true);
					
					//remove selection on Java Map
						map.selectAll("path")
						.style("fill", setNormalColor)
						.attr("stroke-width", 1);
						//end removal section
						
					//remove selection on Java Map
						map2.selectAll("path")
						.style("fill", setNormalColor)
						.attr("stroke-width", 1);
						//end removal section
					
					d3.select("table").remove();
					gjkt.selectAll("circle").remove();
					gjkt.selectAll("rect").remove();
					
				//end moveout
/************************** generate select-self district position and Bubble text ******/									
					ForFilter.style("fill", "purple");
//console.log(d3.select(this))
					var target = d3.select("#tooltip")
						.style("left", leftbuble+"px")
						.style("top", topbuble+"px")
						.style("width", widthbuble+"px")
						.style("height", heightbuble+"px");

					target.select("#daerah").text("Origin : "+DvalueForFilter.properties.KAB_KOTA+" - " + DvalueForFilter.properties.PROPINSI);
					//target.select("#info").text(getInfo2(d));

					//Show tooltip
					d3.select("#tooltip").classed("hidden", false);
					
/************************** generate table info *****************************************/
					var totalsend = 0;
					if(d3.select("#legendJKT").empty()) {legendinJak();}
					if(d3.select("#legendJKTR").empty()) {legendRepJak();}
					if(d3.select("#legendJV").empty()) {legendinJava();}
					if(d3.select("#legendJVR").empty()) {legendRepJava();}
					d3.select("#legendJKT").classed("hidden", false);
					d3.select("#legendJKTR").classed("hidden", true);
					d3.select("#legendJV").classed("hidden", true);
					d3.select("#legendJVR").classed("hidden", false);
					
					if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
					{
						getInfoDestfromOri(DvalueForFilter,"district");
						var datamovjavconvert = DataConverter2(datamovjav,"ori_to_dest","district");	
						var datamovjavconvertaddtot = addTotalField(datamovjavconvert);
						totalsend = addTotalSendOrReceive(datamovjavconvert);
						target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
						d3.select("#ljv1R").text(totalsend+" species");
						var JavTable = tabulate2(datamovjavconvertaddtot);
						minmaxvaljkt = getMaxTot(datamovjavconvertaddtot);
						deviderLegend(minmaxvaljkt,"JKT")
						
						getInfoDestfromOri(DvalueForFilter,"subdistrict");
						var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
						var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
						
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
					}
					else if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "SD+LBM" )
					{
						getInfoDestfromOri(DvalueForFilter,"subdistrict");
						var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
						var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
						totalsend = addTotalSendOrReceive(datamovjavconvertSD);
						target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
						d3.select("#ljv1R").text(totalsend+" species");
						var JavTable = tabulate2(datamovjavconvertaddtotSD);
						minmaxvaljkt = getMaxTot(datamovjavconvertaddtotSD);
						deviderLegend(minmaxvaljkt,"JKT")
						
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
					}
					else if (destinationmenu == "LBM")
					{
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
						

						//convert cy_id_new into LBM name
						d3.csv("dest2lbm.csv", function(lbms)
						{
							var dt_lbm = [];
							var n = 0;
							for (var i = 0; i < lbms.length; i++)
							{
								for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
								{	
					
									if(lbms[i].marketCode == datamovjavconvertaddtotLBM[j].dest)
									{	
										dt_lbm[n] = datamovjavconvertaddtotLBM[j];
										dt_lbm[n].dest = lbms[i].name
										n = n + 1;
									}
								}
							}
							var JavTable = tabulate2(dt_lbm);
							minmaxvaljkt = getMaxTot(dt_lbm);
							deviderLegend(minmaxvaljkt,"JKT")
							totalsendLBM = addTotalSendOrReceive(dt_lbm);
							target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendLBM+" species");
							d3.select("#ljv1R").text(totalsendLBM+" species");
							
			
						})
					}
					

/************************** generate position district on JKT MAP **********************************/
					if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
					{
						//get the origin cities based on selected destination
						var destcity = getDestCity(DvalueForFilter, "district");
						var dt = function(ori, dest) 
						{

							var result = [];
							var n = 0;
							for (var i = 0; i < dest.length; i++)
							{

								 var dataState = dest[i];
								 //Find the corresponding state inside the GeoJSON
								for (var j = 0; j < ori.features.length; j++)
								{
									var jsonState = ori.features[j].properties.KAB_KOTA;
									if (dataState == jsonState ) {
										result[n] = ori.features[j];
										n = n + 1;
										break;
									}
								}
							}
							return result
						}; 
						var dataselectedD = dt(jakjson, destcity); 

						for (var i = 0; i < dataselectedD.length; i++)
						{
							for (var j = 0; j < datamovjavconvertaddtot.length; j++)
							{
								if (dataselectedD[i].properties.KAB_KOTA == datamovjavconvertaddtot[j].dest)
								{
									dataselectedD[i].properties.total = datamovjavconvertaddtot[j].total
								}
							}
						}
						map.selectAll("path")
							.data(dataselectedD, function(d) { return d.properties.OBJECTID; })
							.style("fill", setJktColor)//"purple")//color(js.properties.value))
							.attr("stroke-width", 2);
					}
					
/************************** generate position subdistrict *******************************/
					if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "D+SD" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
					{
						var destsd = getDestCity(DvalueForFilter, "subdistrict");

						var dtsd = function(datassd) 
						{

							d3.csv("dest1dki.csv", function(sds)
							{
								var result = [];
								var n = 0;
								var possd = [];
								for (var i = 0; i < datassd.length; i++)
								{

									 var dataState = datassd[i];
									 //Find the corresponding state inside the GeoJSON
									for (var j = 0; j < sds.length; j++)
									{
										var jsonState = sds[j].subdistrict;
										if (dataState == jsonState ) {
											result[n] = sds[j];
											var Lat = (-1*sds[j].gps_north_degree) - (+sds[j].gps_north_minute/100),
											Long = (1*sds[j].gps_east_degree) + (+sds[j].gps_east_minute/100),
											location = [+Long, +Lat];
											sds[j].location = location;
											possd.push(projection(location));
											n = n + 1;
											break;
										}
									}
								}
								var g = gjkt.selectAll("g")
								.data(result)
								//.enter()
								.append("svg:g");
			

								for (var i = 0; i < result.length; i++)
								{
									for (var j = 0; j < datamovjavconvertaddtotSD.length; j++)
									{
										if (result[i].subdistrict == datamovjavconvertaddtotSD[j].dest)
										{
											result[i].total = datamovjavconvertaddtotSD[j].total
										}
									}
								}
								
								//generate the circles
								showCity(result,gjkt,possd,setJktColorSDLBM, "circle");
							
								gjkt.selectAll("circle")
								.on("click", function(d) 
								{

									// replacement for moveout
									d3.select("#tooltip").classed("hidden", true);
									//remove selection on Java Map
									map2.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									
									map.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									// end moveout
									
									var target = d3.select("#tooltip")
											.style("left", leftbuble+"px")
											.style("top", topbuble+"px")
											.style("width", widthbuble+"px")
											.style("height", heightbuble+"px");
										target.select("#daerah")
											.text("DEST Subdistrict :"+d.subdistrict);

										target.select("#info")
											.text("location: " + d.location );
													
					
									//Show tooltip
									d3.select("#tooltip").classed("hidden", false);
					
					
									//get the origin cities based on selected destination
									var oricity = getOriginCity(d);
									
									var dt = function(ori, dest) 
									{

										var result = [];
										var n = 0;
										for (var i = 0; i < dest.length; i++)
										{

											 var dataState = dest[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < ori.features.length; j++)
											{
												var jsonState = ori.features[j].properties.KAB_KOTA;
												if (dataState == jsonState ) {
													result[n] = ori.features[j];
													n = n + 1;
													break;
												}
											}
										}
										return result
									}; 
									//generate all selected origin city on Java Map
									dt_res = dt(javjson,oricity); 
									map2.selectAll("path")
										.data(dt_res, function(d) { 
											return d.properties.OBJECTID; })
										.style("fill", "blue")//color(js.properties.value))
										.attr("stroke-width", 2);
									//end of generation
					 
								})
							})
						
						};
						var dataselectedsd = dtsd(destsd);
					}
/************************** generate position LBM ***************************************/
					if (destinationmenu == "LBM" || destinationmenu == "D+LBM" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
					{
						var destlbm = getDestCity(DvalueForFilter, "lbm");
						var dtlbm = function(dataslbm) 
						{

							d3.csv("dest2lbm.csv", function(lbms)
							{
								var result = [];
								var n = 0;
								var poslbm = [];
								for (var i = 0; i < dataslbm.length; i++)
								{

									 var dataState = dataslbm[i];
									 //Find the corresponding state inside the GeoJSON
									for (var j = 0; j < lbms.length; j++)
									{
										var jsonState = lbms[j].marketCode;
										if (dataState == jsonState ) {
											result[n] = lbms[j];
											var Lat = (-1*lbms[j].LS_Coord_Deg) - (+lbms[j].LS_Coord_Min/100),
												Long = (1*lbms[j].BT_Coord_Deg) + (+lbms[j].BT_Coord_Min/100),
											location = [+Long, +Lat];
											lbms[j].location = location;
											poslbm.push(projection(location));
											n = n + 1;
											break;
										}
									}
								}
								var g = gjkt.selectAll("g")
								.data(result)
								//.enter()
								.append("svg:g");
			
								for (var i = 0; i < result.length; i++)
								{
									for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
									{
										if (result[i].name == datamovjavconvertaddtotLBM[j].dest)
										{
											result[i].total = datamovjavconvertaddtotLBM[j].total
										}
									}
								}

								//generate the circles
								showCity(result,gjkt,poslbm,setJktColorSDLBM, "rect");
							
								gjkt.selectAll("rect")
								.on("click", function(d) 
								{
									//replacement for moveout
									d3.select("#tooltip").classed("hidden", true);
									//remove selection on Java Map
									map2.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									
									//remove selection on Java Map
									map.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									//end moveout
									
									var target = d3.select("#tooltip")
											.style("left", leftbuble+"px")//coordinates[0] + "px")
											.style("top", topbuble+"px")//coordinates[1] + "px")
											.style("width", widthbuble+"px")
											.style("height", heightbuble+"px");
										target.select("#daerah")
											.text("DEST LBM :"+d.name);

										target.select("#info")
											.text("location: " + d.location );
													
					
									//Show tooltip
									d3.select("#tooltip").classed("hidden", false);
					
									//get the origin cities based on selected destination
									var selecteddata = getDistrictBasedOnMarketCode(d);
									var oricity = getOriginCity(selecteddata);
									
									var dt = function(ori, dest) 
									{

										var result = [];
										var n = 0;
										for (var i = 0; i < dest.length; i++)
										{

											 var dataState = dest[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < ori.features.length; j++)
											{
												var jsonState = ori.features[j].properties.KAB_KOTA;
												if (dataState == jsonState ) {
													result[n] = ori.features[j];
													n = n + 1;
													break;
												}
											}
										}
										return result
									}; 
									//generate all selected origin city on Java Map
									dt_res = dt(javjson,oricity); 
									map2.selectAll("path")
										.data(dt_res, function(d) { 
											return d.properties.OBJECTID; })
										.style("fill", "red")//color(js.properties.value))
										.attr("stroke-width", 2);
									//end of generation
								})
							})
						
						};
						var dataselectedlbm = dtlbm(destlbm);
					}
				}
			}
                        
			
			//function filter for species
			function datafilter(origin, collector, destination, species, connection)
			{	
				//reset data variable into original data
				data = datadump;
								
				if (species.length != 0)
				{
					var datafilter = [];
					var n = 0;
					for (var j = 0; j < species.length; j++)
					{
						var selectedspecies = species[j];
						for (var i = 0; i < data.length; i++) 
						{ 
							if (data[i].species == selectedspecies ) 
							{
								datafilter[n] = data[i];
								n = n + 1; 
								//break;
							} 
						};
						
					}
						
					data = datafilter;

					if (typeof DvalueForFilter != 'undefined')
					{	
						d3.select("table").remove();
						
						//replacement for moveout
						ForFilter.style("fill", setNormalColor(DvalueForFilter));
						d3.select("#tooltip").classed("hidden", true);
					
						//remove selection on Java Map
							map.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
						
						//remove selection on Java Map
							map2.selectAll("path")
							.style("fill", setNormalColor)
							.attr("stroke-width", 1);
							//end removal section
					
						d3.select("table").remove();
						gjkt.selectAll("circle").remove();
						gjkt.selectAll("rect").remove();
					
					//end moveout

/************************** generate select-self district position and Bubble text ******/									
					ForFilter.style("fill", "purple");
//console.log(d3.select(this))
					var target = d3.select("#tooltip")
						.style("left", leftbuble+"px")
						.style("top", topbuble+"px")
						.style("width", widthbuble+"px")
						.style("height", heightbuble+"px");

					target.select("#daerah").text("Origin : "+DvalueForFilter.properties.KAB_KOTA+" - " + DvalueForFilter.properties.PROPINSI);
					//target.select("#info").text(getInfo2(d));

					//Show tooltip
					d3.select("#tooltip").classed("hidden", false);
					
/************************** generate table info *****************************************/
					var totalsend = 0;
					if(d3.select("#legendJKT").empty()) {legendinJak();}
					if(d3.select("#legendJKTR").empty()) {legendRepJak();}
					if(d3.select("#legendJV").empty()) {legendinJava();}
					if(d3.select("#legendJVR").empty()) {legendRepJava();}
					d3.select("#legendJKT").classed("hidden", false);
					d3.select("#legendJKTR").classed("hidden", true);
					d3.select("#legendJV").classed("hidden", true);
					d3.select("#legendJVR").classed("hidden", false);
					
					if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
					{
						getInfoDestfromOri(DvalueForFilter,"district");
						var datamovjavconvert = DataConverter2(datamovjav,"ori_to_dest","district");	
						var datamovjavconvertaddtot = addTotalField(datamovjavconvert);
						totalsend = addTotalSendOrReceive(datamovjavconvert);
						target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
						d3.select("#ljv1R").text(totalsend+" species");
						var JavTable = tabulate2(datamovjavconvertaddtot);
						minmaxvaljkt = getMaxTot(datamovjavconvertaddtot);
						deviderLegend(minmaxvaljkt,"JKT")
						
						getInfoDestfromOri(DvalueForFilter,"subdistrict");
						var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
						var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
						
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
					}
					else if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "SD+LBM" )
					{
						getInfoDestfromOri(DvalueForFilter,"subdistrict");
						var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");	
						var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
						totalsend = addTotalSendOrReceive(datamovjavconvertSD);
						target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
						d3.select("#ljv1R").text(totalsend+" species");
						var JavTable = tabulate2(datamovjavconvertaddtotSD);
						minmaxvaljkt = getMaxTot(datamovjavconvertaddtotSD);
						deviderLegend(minmaxvaljkt,"JKT")
						
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
					}
					else if (destinationmenu == "LBM")
					{
						getInfoDestfromOri(DvalueForFilter,"lbm");
						var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");	
						var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
						

						//convert cy_id_new into LBM name
						d3.csv("dest2lbm.csv", function(lbms)
						{
							var dt_lbm = [];
							var n = 0;
							for (var i = 0; i < lbms.length; i++)
							{
								for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
								{	
					
									if(lbms[i].marketCode == datamovjavconvertaddtotLBM[j].dest)
									{	
										dt_lbm[n] = datamovjavconvertaddtotLBM[j];
										dt_lbm[n].dest = lbms[i].name
										n = n + 1;
									}
								}
							}
							var JavTable = tabulate2(dt_lbm);
							minmaxvaljkt = getMaxTot(dt_lbm);
							deviderLegend(minmaxvaljkt,"JKT")
							totalsendLBM = addTotalSendOrReceive(dt_lbm);
							target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendLBM+" species");
							d3.select("#ljv1R").text(totalsendLBM+" species");
							
			
						})
					}
					

/************************** generate position district on JKT MAP **********************************/
					if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
					{
						//get the origin cities based on selected destination
						var destcity = getDestCity(DvalueForFilter, "district");
						var dt = function(ori, dest) 
						{

							var result = [];
							var n = 0;
							for (var i = 0; i < dest.length; i++)
							{

								 var dataState = dest[i];
								 //Find the corresponding state inside the GeoJSON
								for (var j = 0; j < ori.features.length; j++)
								{
									var jsonState = ori.features[j].properties.KAB_KOTA;
									if (dataState == jsonState ) {
										result[n] = ori.features[j];
										n = n + 1;
										break;
									}
								}
							}
							return result
						}; 
						var dataselectedD = dt(jakjson, destcity); 

						for (var i = 0; i < dataselectedD.length; i++)
						{
							for (var j = 0; j < datamovjavconvertaddtot.length; j++)
							{
								if (dataselectedD[i].properties.KAB_KOTA == datamovjavconvertaddtot[j].dest)
								{
									dataselectedD[i].properties.total = datamovjavconvertaddtot[j].total
								}
							}
						}
						map.selectAll("path")
							.data(dataselectedD, function(d) { return d.properties.OBJECTID; })
							.style("fill", setJktColor)//"purple")//color(js.properties.value))
							.attr("stroke-width", 2);
					}
					
/************************** generate position subdistrict *******************************/
					if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "D+SD" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
					{
						var destsd = getDestCity(DvalueForFilter, "subdistrict");

						var dtsd = function(datassd) 
						{

							d3.csv("dest1dki.csv", function(sds)
							{
								var result = [];
								var n = 0;
								var possd = [];
								for (var i = 0; i < datassd.length; i++)
								{

									 var dataState = datassd[i];
									 //Find the corresponding state inside the GeoJSON
									for (var j = 0; j < sds.length; j++)
									{
										var jsonState = sds[j].subdistrict;
										if (dataState == jsonState ) {
											result[n] = sds[j];
											var Lat = (-1*sds[j].gps_north_degree) - (+sds[j].gps_north_minute/100),
											Long = (1*sds[j].gps_east_degree) + (+sds[j].gps_east_minute/100),
											location = [+Long, +Lat];
											sds[j].location = location;
											possd.push(projection(location));
											n = n + 1;
											break;
										}
									}
								}
								var g = gjkt.selectAll("g")
								.data(result)
								//.enter()
								.append("svg:g");
			

								for (var i = 0; i < result.length; i++)
								{
									for (var j = 0; j < datamovjavconvertaddtotSD.length; j++)
									{
										if (result[i].subdistrict == datamovjavconvertaddtotSD[j].dest)
										{
											result[i].total = datamovjavconvertaddtotSD[j].total
										}
									}
								}
								
								//generate the circles
								showCity(result,gjkt,possd,setJktColorSDLBM, "circle");
							
								gjkt.selectAll("circle")
								.on("click", function(d) 
								{

									// replacement for moveout
									d3.select("#tooltip").classed("hidden", true);
									//remove selection on Java Map
									map2.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									
									map.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									// end moveout
									
									var target = d3.select("#tooltip")
											.style("left", leftbuble+"px")
											.style("top", topbuble+"px")
											.style("width", widthbuble+"px")
											.style("height", heightbuble+"px");
										target.select("#daerah")
											.text("DEST Subdistrict :"+d.subdistrict);

										target.select("#info")
											.text("location: " + d.location );
													
					
									//Show tooltip
									d3.select("#tooltip").classed("hidden", false);
					
					
									//get the origin cities based on selected destination
									var oricity = getOriginCity(d);
									
									var dt = function(ori, dest) 
									{

										var result = [];
										var n = 0;
										for (var i = 0; i < dest.length; i++)
										{

											 var dataState = dest[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < ori.features.length; j++)
											{
												var jsonState = ori.features[j].properties.KAB_KOTA;
												if (dataState == jsonState ) {
													result[n] = ori.features[j];
													n = n + 1;
													break;
												}
											}
										}
										return result
									}; 
									//generate all selected origin city on Java Map
									dt_res = dt(javjson,oricity); 
									map2.selectAll("path")
										.data(dt_res, function(d) { 
											return d.properties.OBJECTID; })
										.style("fill", "blue")//color(js.properties.value))
										.attr("stroke-width", 2);
									//end of generation
					 
								})
							})
						
						};
						var dataselectedsd = dtsd(destsd);
					}
/************************** generate position LBM ***************************************/
					if (destinationmenu == "LBM" || destinationmenu == "D+LBM" || destinationmenu == "SD+LBM" || destinationmenu == "D+SD+LBM")
					{
						var destlbm = getDestCity(DvalueForFilter, "lbm");
						var dtlbm = function(dataslbm) 
						{

							d3.csv("dest2lbm.csv", function(lbms)
							{
								var result = [];
								var n = 0;
								var poslbm = [];
								for (var i = 0; i < dataslbm.length; i++)
								{

									 var dataState = dataslbm[i];
									 //Find the corresponding state inside the GeoJSON
									for (var j = 0; j < lbms.length; j++)
									{
										var jsonState = lbms[j].marketCode;
										if (dataState == jsonState ) {
											result[n] = lbms[j];
											var Lat = (-1*lbms[j].LS_Coord_Deg) - (+lbms[j].LS_Coord_Min/100),
												Long = (1*lbms[j].BT_Coord_Deg) + (+lbms[j].BT_Coord_Min/100),
											location = [+Long, +Lat];
											lbms[j].location = location;
											poslbm.push(projection(location));
											n = n + 1;
											break;
										}
									}
								}
								var g = gjkt.selectAll("g")
								.data(result)
								//.enter()
								.append("svg:g");
			
								for (var i = 0; i < result.length; i++)
								{
									for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
									{
										if (result[i].name == datamovjavconvertaddtotLBM[j].dest)
										{
											result[i].total = datamovjavconvertaddtotLBM[j].total
										}
									}
								}

								//generate the circles
								showCity(result,gjkt,poslbm,setJktColorSDLBM, "rect");
							
								gjkt.selectAll("rect")
								.on("click", function(d) 
								{
									//replacement for moveout
									d3.select("#tooltip").classed("hidden", true);
									//remove selection on Java Map
									map2.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									
									//remove selection on Java Map
									map.selectAll("path")
									.style("fill", setNormalColor)
									.attr("stroke-width", 1);
									//end removal section
									//end moveout
									
									var target = d3.select("#tooltip")
											.style("left", leftbuble+"px")//coordinates[0] + "px")
											.style("top", topbuble+"px")//coordinates[1] + "px")
											.style("width", widthbuble+"px")
											.style("height", heightbuble+"px");
										target.select("#daerah")
											.text("DEST LBM :"+d.name);

										target.select("#info")
											.text("location: " + d.location );
													
					
									//Show tooltip
									d3.select("#tooltip").classed("hidden", false);
					
									//get the origin cities based on selected destination
									var selecteddata = getDistrictBasedOnMarketCode(d);
									var oricity = getOriginCity(selecteddata);
									
									var dt = function(ori, dest) 
									{

										var result = [];
										var n = 0;
										for (var i = 0; i < dest.length; i++)
										{

											 var dataState = dest[i];
											 //Find the corresponding state inside the GeoJSON
											for (var j = 0; j < ori.features.length; j++)
											{
												var jsonState = ori.features[j].properties.KAB_KOTA;
												if (dataState == jsonState ) {
													result[n] = ori.features[j];
													n = n + 1;
													break;
												}
											}
										}
										return result
									}; 
									//generate all selected origin city on Java Map
									dt_res = dt(javjson,oricity); 
									map2.selectAll("path")
										.data(dt_res, function(d) { 
											return d.properties.OBJECTID; })
										.style("fill", "red")//color(js.properties.value))
										.attr("stroke-width", 2);
									//end of generation
								})
							})
						
						};
						var dataselectedlbm = dtlbm(destlbm);
			
					}
					
					}

				}	
				
			}
			
			//Store original data for reset function
			function datdum()
			{
				d3.xhr('Movement.csv').get(function (err, response) 
				{
					//if (error) throw error;
					var dirtyCSV = response.responseText;
					var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
					datadump = d3.csv.parse(cleanCSV);

				});
			}
			
			//additional function to generate tabular2
			function recurse(sel) 
			{
				// sel is a d3.selection of one or more empty tables
				sel.each(function(d) {
				// d is an array of objects
				var colnames,
					tds,
					table = d3.select(this);

				// obtain column names by gathering unique key names in all 1st level objects
				// following method emulates a set by using the keys of a d3.map()
				colnames = d                                                          // array of objects
					.reduce(function(p,c) { return p.concat(d3.keys(c)); }, [])       // array with all keynames
					.reduce(function(p,c) { return (p.set(c,0), p); }, d3.map())      // map with unique keynames as keys
					.keys();                                                          // array with unique keynames (arb. order)

				// colnames array is in arbitrary order
				// sort colnames here if required

				// create header row using standard 1D data join and enter()
				table.append("thead").append("tr").selectAll("th")
					.data(colnames)
					.enter()
					.append("th")
					.text(function(d) //.text(function(d) { return d; });
						{ 
							if (d == "species"){d = "Species"}
							if (d == "dest_and_tot"){d = "Destination and Total"}
							if (d == "spec_and_tot"){d = "Detail"}
							if (d == "dest")
							{
								if (destinationmenu == "District (D)" || destinationmenu == "D+SD" || destinationmenu == "D+LBM" || destinationmenu == "D+SD+LBM")
								{
									d = "Destination (District)"
								}
								else if (destinationmenu == "SubDistrict (SD)" || destinationmenu == "SD+LBM" )
								{
									d = "Destination   (Sub District)"
								}
								else if (destinationmenu == "LBM")
								{
									d = "Destination (LBM)"
								}
								
							}
							if (d == "ori"){d = "Origin"}
							if (d == "tot_week_vol"){d = "Weekly Volume"}
							if (d == "total"){d = "Total Weekly Volume"}
		
							return d; 
						});

				// create the table cells by using nested 2D data join and enter()
				tds = table.append("tbody").selectAll("tr")
					.data(d)                            			// each row gets one object
				  	.enter()
				  	.append("tr")
				  	.selectAll("td")
					.data(function(d) 
						{                 							// each cell gets one value
							return colnames.map(function(k) 
							{										// for each colname (i.e. key) find the corresponding value
								return d[k] || "";              	// use empty string if key doesn't exist for that object
							});
						})
					.enter()
					.append("td");

				// cell contents depends on the data bound to the cell
				// fill with text if data is not an Array
				tds.filter(function(d) { return !(d instanceof Array); })
					.text(function(d) { return d; });
				// fill with a new table if data is an Array
				tds.filter(function(d) { return (d instanceof Array); })
					.append("table")
					.call(recurse);
				});
			}
			
			//function to convert the "key" and "values"
			function DataConverter (dataori,type,model)//type = {"ori to dest", "dest to ori"}| model = {"district","subdistrict","LBM"}
			{
				for (var i = 0; i < dataori.length; i++)

				{
					dataori[i].species = dataori[i].key;
					dataori[i].dest_and_tot = dataori[i].values;
					for (var j = 0; j < dataori[i].values.length; j++)
					{
						dataori[i].dest_and_tot[j].dest = dataori[i].values[j].key;
						dataori[i].dest_and_tot[j].tot_week_vol = dataori[i].values[j].values;
						delete 	dataori[i].values[j].key;
						delete dataori[i].values[j].values;
					}
					delete dataori[i].key;
					delete dataori[i].values;
				};
				return dataori;
			}
			
			//function to convert the "key" and "values"
			function DataConverter2 (dataori,type,model)//type = {"ori to dest", "dest to ori"}| model = {"district","subdistrict","LBM"}
			{
//console.log(dataori)
				for (var i = 0; i < dataori.length; i++)

				{
					if (type == "ori_to_dest"){dataori[i].dest = dataori[i].key;}
					if (type == "dest_to_ori"){dataori[i].ori = dataori[i].key;}
					dataori[i].spec_and_tot = dataori[i].values;
					for (var j = 0; j < dataori[i].values.length; j++)
					{
						dataori[i].spec_and_tot[j].species = dataori[i].values[j].key;
						if (dataori[i].values[j].values != 0)
						dataori[i].spec_and_tot[j].tot_week_vol = dataori[i].values[j].values;
						delete 	dataori[i].values[j].key;
						delete dataori[i].values[j].values;
					}
					delete dataori[i].key;
					delete dataori[i].values;
				};
				return dataori;
			}
			
			function deviderLegend(minmaxval,peta)
			{
				var legVal = []
				if (minmaxval[0] != minmaxval[1])
				{
					d3.select("#ljv3").classed("hidden", false);
					d3.select("#ljv4").classed("hidden", false);
					d3.select("#ljv5").classed("hidden", false);
					d3.select("#ljkt3").classed("hidden", false);
					d3.select("#ljkt4").classed("hidden", false);
					d3.select("#ljkt5").classed("hidden", false);
					d3.select("#ljvb3").classed("hidden", false);
					d3.select("#ljvb4").classed("hidden", false);
					d3.select("#ljvb5").classed("hidden", false);
					d3.select("#ljktb3").classed("hidden", false);
					d3.select("#ljktb4").classed("hidden", false);
					d3.select("#ljktb5").classed("hidden", false);
					for (var i = 1; i < 5; i++)
					{
						legVal[4-i] = Math.round(minmaxval[0]+((minmaxval[1]-minmaxval[0]) - (((minmaxval[1]-minmaxval[0])/4)*i)));
					}
				}
				else if (minmaxval[0] == 0 && minmaxval[1] == 0 || typeof minmaxval[0] == 'undefined' && typeof minmaxval[1] == 'undefined')
				{
					d3.select("#legendJKT").classed("hidden", true);
					d3.select("#legendJV").classed("hidden", true);
				}
				else
				{
					legVal[0] = "1";
					legVal[1] = minmaxval[1];
					d3.select("#ljv3").classed("hidden", true);
					d3.select("#ljv4").classed("hidden", true);
					d3.select("#ljv5").classed("hidden", true);
					d3.select("#ljkt3").classed("hidden", true);
					d3.select("#ljkt4").classed("hidden", true);
					d3.select("#ljkt5").classed("hidden", true);
					d3.select("#ljvb3").classed("hidden", true);
					d3.select("#ljvb4").classed("hidden", true);
					d3.select("#ljvb5").classed("hidden", true);
					d3.select("#ljktb3").classed("hidden", true);
					d3.select("#ljktb4").classed("hidden", true);
					d3.select("#ljktb5").classed("hidden", true);
				}

				if(peta == "JV" )
				{
					d3.select("#ljv1").text("0");
					d3.select("#ljv2").text(legVal[0]+" - "+legVal[1]);
					d3.select("#ljv3").text(legVal[1]+1+" - "+legVal[2]);
					d3.select("#ljv4").text(legVal[2]+1+" - "+legVal[3]);
					d3.select("#ljv5").text(legVal[3]+1+" - "+minmaxval[1]);
					
					ljv1 = legVal[0];
					ljv2 = legVal[1];
					ljv3 = legVal[2];
					ljv4 = legVal[3];
					ljv5 = minmaxval[1];
					
				}
				if(peta == "JKT")
				{
					d3.select("#ljkt1").text("0");
					d3.select("#ljkt2").text(legVal[0]+" - "+legVal[1]);
					d3.select("#ljkt3").text(legVal[1]+1+" - "+legVal[2]);
					d3.select("#ljkt4").text(legVal[2]+1+" - "+legVal[3]);
					d3.select("#ljkt5").text(legVal[3]+1+" - "+minmaxval[1]);
					
					ljkt1 = legVal[0];
					ljkt2 = legVal[1];
					ljkt3 = legVal[2];
					ljkt4 = legVal[3];
					ljkt5 = minmaxval[1];
				}
			}

            function addTotalField(data)
            {
            	for (var i = 0; i < data.length; i++)
				{
					var total = 0;
					for (var j = 0; j < data[i].spec_and_tot.length; j++)
					{
						total = total + data[i].spec_and_tot[j].tot_week_vol;
					}
					data[i].total = total
				}
				return data;
            }
            
            function addTotalSendOrReceive(data)
            {

            	var total = 0;
            	for (var i = 0; i < data.length; i++)
				{	
					for (var j = 0; j < data[i].spec_and_tot.length; j++)
					{
						total = total + data[i].spec_and_tot[j].tot_week_vol;
					}
				}
				return total;
            }
            
            function getMaxTot(d)
 			{
 				dvalue = [];
 				d.forEach(function(datvalue,i) 
 				{
 					dvalue[i] = datvalue.total;
 				})
 				

				var minmaxval = []
				minmaxval[0] = d3.min(dvalue);
				minmaxval[1] = d3.max(dvalue);
				return minmaxval
 				
 			}
 			
 			function getMaxTotNested(datamov)
 			{	
				// function for looking min max based on dest and species
				var minmaxval = []
				minmaxval[1] = d3.max(d3.entries(datamov), function(d) {
				  return d3.max(d3.entries(d.value), function(e) {
					  return d3.max(e.value, function(f) { return f.tot_week_vol; });
				  });
				});
				
				
				minmaxval[0] = d3.min(d3.entries(datamov), function(d) {
				  return d3.min(d3.entries(d.value), function(e) {
					  return d3.min(e.value, function(f) { return f.tot_week_vol; });
				  });
				});
				
				return minmaxval
 				
 			}
				
/****************************************************************************************/
            //set the interface
            
            //get data from the movement csv
            getcsvdata();
            //keep original data to other variable 
            datdum();
   
            //added  title for the interface
            titleinterface()
            
            //added graph bar
            //scalegraph();
            //legendinJava();
            //legendinJak();
            
            //added filter(s)
            Filter1_Origins();
            Filter2_Collectors();
            Filter3_Destinations();
            Filter4_Species();
            Filter5_Connections();
            
            
            //added jabodetabek map
            d3.json("jakarta.json", function(json) {				
				jakjson = json;
				updateMapJKT(json);									      
            });
                   
        	// generate SVG for second Geojson MAP (java island)  
			d3.json("indonesia_districts_java_only.json", function(json) {
				
				javjson = json;  
             	updateMapJAVA(json);
            });
            
            
            
			
            
            

/****************************************************************************************/
                        
        </script>

    </body>

</html>