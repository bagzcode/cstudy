<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>D3: Project Birds Mapping</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript" src="../js/jquery-1.11.3.min.js"></script>
  <script type="text/javascript" src="../js/bootstrap.min.js"></script>
  <script type="text/javascript" src="../js/d3/d3.min.js"></script>
</head>
<body>
  <div class="container-fluid">

    <!-- Header -->
    <div class="row">
      <div class="col-md-12">
        <h3>Movement Tool : Connections of Collectors, Live Bird Markets and district of origin for live birds traded in JABODETABEK</h3>
      </div>
    </div>

    <!-- Content/Body -->
    <div class="row">

      <!-- Map Goes Here~ -->
      <div class="col-md-8">
      </div>

      <!-- Filter -->
      <div class="col-md-4">
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

          <!-- first panel -->
          <div class="panel panel-info">
            <div class="panel-heading" role="tab" id="heading_search_markets_and_collectors">
              <h6 class="panel-title">
                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse_search_markets_and_collectors" aria-expanded="true" aria-controls="collapse_search_markets_and_collectors">
                  Search Markets and collectors in JABODETABEK
                </a>
              </h6>
            </div>
            <div id="collapse_search_markets_and_collectors" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_search_markets_and_collectors">
              <div class="panel-body">
                <!-- sub panel -->
                <div class="panel-group" id="sub_accordion_search_markets_and_collectors" role="tablist" aria-multiselectable="true">
                  <!-- sub first panel / Search Collectors connected to a Market -->
                  <div class="panel panel-info">
                    <div class="panel-heading" role="tab" id="heading_search_collectors">
                      <h6 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#sub_accordion_search_markets_and_collectors" href="#collapse_search_collectors" aria-expanded="true" aria-controls="collapse_search_collectors">
                          Search Collectors connected to a Market
                        </a>
                      </h6>
                    </div>
                    <div id="collapse_search_collectors" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_search_collectors">
                      <div class="panel-body">
                        <!-- isi filter -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By name or number
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> All markets in sub-district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> All markets in district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-inline">
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ayam Kampung
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Broiler
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ducks
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Layer
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> <b>ALL</b>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="panel panel-footer">
                        <div class="form-group">
                          <button class="btn btn-primary btn-block">Get Data!</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- end of sub first panel / Search Collectors connected to a Market -->

                  <!-- sub second panel / Search Markets connected to a Collector -->
                  <div class="panel panel-info">
                    <div class="panel-heading" role="tab" id="heading_search_markets">
                      <h6 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#sub_accordion_search_markets_and_collectors" href="#collapse_search_markets" aria-expanded="true" aria-controls="collapse_search_markets">
                          Search Markets connected to a Collector
                        </a>
                      </h6>
                    </div>
                    <div id="collapse_search_markets" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_search_markets">
                      <div class="panel-body">
                        <!-- isi filter -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By name or number
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> All markets in sub-district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> All markets in district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-inline">
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ayam Kampung
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Broiler
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ducks
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Layer
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> <b>ALL</b>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="panel panel-footer">
                        <div class="form-group">
                          <button class="btn btn-primary btn-block">Get Data!</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- end of sub second panel / Search Markets connected to a Collector -->

                </div> <!-- end of sub panel -->
              </div>
            </div>
          </div> <!-- end of first panel -->

          <!-- second panel -->
          <div class="panel panel-success">
            <div class="panel-heading" role="tab" id="heading_search_poultry">
              <h6 class="panel-title">
                <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapse_search_poultry" aria-expanded="false" aria-controls="collapse_search_poultry">
                  Search Poultry District of Origin of Poultry in Jakarta
                </a>
              </h6>
            </div>
            <div id="collapse_search_poultry" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_search_poultry">
              <div class="panel-body">
                <!-- sub panel -->
                <div class="panel-group" id="sub_accordion_search_poultry" role="tablist" aria-multiselectable="true">
                  <!-- sub first panel / Search Districts of poultry origin of Collectors -->
                  <div class="panel panel-success">
                    <div class="panel-heading" role="tab" id="heading_poultry_origin_of_collectors">
                      <h6 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#sub_accordion_search_poultry" href="#collapse_poultry_origin_of_collectors" aria-expanded="true" aria-controls="collapse_poultry_origin_of_collectors">
                          Search Districts of poultry origin of Collectors
                        </a>
                      </h6>
                    </div>
                    <div id="collapse_poultry_origin_of_collectors" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_poultry_origin_of_collectors">
                      <div class="panel-body">
                        <!-- isi filter -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By name or number
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By sub-district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By JABODETABEK district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-inline">
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ayam Kampung
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Broiler
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ducks
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Layer
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> <b>ALL</b>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="panel panel-footer">
                        <div class="form-group">
                          <button class="btn btn-primary btn-block">Get Data!</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- end of sub first panel / Search Districts of poultry origin of Collectors -->

                  <!-- sub second panel / Search Districts of poultry origin of Livebird markets* -->
                  <div class="panel panel-success">
                    <div class="panel-heading" role="tab" id="heading_poultry_origin_of_livebirds_markets">
                      <h6 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#sub_accordion_search_poultry" href="#collapse_poultry_origin_of_livebirds_markets" aria-expanded="true" aria-controls="collapse_poultry_origin_of_livebirds_markets">
                          Search Districts of poultry origin of Livebird markets*
                        </a>
                      </h6>
                    </div>
                    <div id="collapse_poultry_origin_of_livebirds_markets" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_poultry_origin_of_livebirds_markets">
                      <div class="panel-body">
                        <!-- isi filter -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By name or number
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By sub-district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> By district
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-inline">
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ayam Kampung
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Broiler
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ducks
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Layer
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> <b>ALL</b>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="panel panel-footer">
                        <div class="form-group">
                          <button class="btn btn-primary btn-block">Get Data!</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- end of sub second panel / Search Districts of poultry origin of Livebird markets* -->

                </div> <!-- end of sub panel -->
                <div class="row">
                  <div class="col-md-12">
                    <i style="color:#8A6D3B">* ONLY FOR POULTRY CONNECTED TO COLLECTORS IN JABODETABEK</i>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- end of second panel -->

          <!-- third panel -->
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="heading_search_destination">
              <h6 class="panel-title">
                <a role="button" class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapse_search_destination" aria-expanded="false" aria-controls="collapse_search_destination">
                  Search Destination of birds from a district
                </a>
              </h6>
            </div>
            <div id="collapse_search_destination" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_search_destination">
              <div class="panel-body">
                <!-- sub panel -->
                <div class="panel-group" id="sub_accordion_search_destination" role="tablist" aria-multiselectable="true">
                  <!-- sub first panel / Search Districts of poultry origin of Collectors -->
                  <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="heading_birds_district_of_origin">
                      <h6 class="panel-title">
                        <a role="button" data-toggle="collapse" data-parent="#sub_accordion_search_destination" href="#collapse_birds_district_of_origin" aria-expanded="true" aria-controls="collapse_birds_district_of_origin">
                          Search Destinations of birds district of origin
                        </a>
                      </h6>
                    </div>
                    <div id="collapse_birds_district_of_origin" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="heading_birds_district_of_origin">
                      <div class="panel-body">
                        <!-- isi filter -->
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> Display only LBM destination
                                </label>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="Type district name or select on map">
                            </div>
                          </div>
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> Display only collector destinations
                                </label>
                              </div>
                            </div>
                          </div>
                          <!-- <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div> -->
                        </div>
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <div class="checkbox">
                                <label>
                                  <input type="checkbox"> Display collector and LBM destination
                                </label>
                              </div>
                            </div>
                          </div>
                          <!-- <div class="col-md-6">
                            <div class="form-group">
                              <input type="text" class="form-control input-sm" placeholder="(enter name or click on map)">
                            </div>
                          </div> -->
                        </div>
                        <div class="row">
                          <div class="col-md-12">
                            <div class="form-inline">
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ayam Kampung
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Broiler
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Ducks
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> Layer
                                  </label>
                                </div>
                              </div>
                              <div class="form-group">
                                <div class="checkbox">
                                  <label>
                                    <input type="checkbox"> <b>ALL</b>
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="panel panel-footer">
                        <div class="form-group">
                          <button class="btn btn-primary btn-block">Get Data!</button>
                        </div>
                      </div>
                    </div>
                  </div> <!-- end of sub first panel / Search Districts of poultry origin of Collectors -->

                </div> <!-- end of sub panel -->
              </div>
            </div>
          </div> <!-- end of third panel -->

        </div> <!-- end of panel -->
      </div>  <!-- end of filter -->

    </div><!-- end of Content/Body -->

  </div>


    <div id="tooltip" class="hidden">
        <p><strong><span id="daerah"></span></strong></p>
        <p id="info">Additional Information for selected area can be showed here</p>
    </div>

    <div id="tooltip2" class="hidden">
        <p><strong><span id="daerah"></span></strong></p>
    </div>

    <script type="text/javascript">

        //var global
        var margin = 25,
            marginforlegend = 10,
            width = window.innerWidth - margin,
            height = window.innerHeight - margin;
            if (width < 1200) { width = 1200 }
            if (height < 1000) { height = 1000 }

        var clistw = 250,
            clisth = 300,
            jktw = width*5/8,//(width-15*margin),///2,
            jkth = (height-8*margin)*5/8,//jktw*3/4,
            jktx = 0,//width-jktw-15*margin,//400,
            jww = width*5/8,//width-15*margin,
            jwh = (height-8*margin)*3/8//height-7*margin,//height-jkth-5*margin,
            filterwidth = 120,
            widthbuble = 1/4*width,
            heightbuble = 70,
            leftbuble = jktw + (3*margin),
            topbuble = 6*margin+8,
            outermargin = 3/10*width,
            innermargin = 3/10*width,

            svg = d3.select("body")
                .append("svg:svg")
                .attr("height", height)
                .attr("width", width)
                .attr("border",1),
            defs = svg.append("svg:defs"),
            canvas = svg.append("svg:g")
                .attr("id", "canvas")
                .attr("height", height - 5*margin)
                .attr("transform", "translate("+margin+","+6*margin+")"),
            label = canvas.append("svg:g")
                .attr("id", "label")
                .attr("transform", "translate("+clistw+",0)"),
            map3 = canvas.append("svg:svg")
                .attr("id", "map3")
                .attr("x", 0)
                .attr("width", jktw)
                .attr("height", jkth+jwh)
                .append("svg:g"),
            map2 = canvas.append("svg:svg")
                .attr("id", "map2")
                .attr("x", 0)
                .attr("y", jkth)
                .attr("width", jww)
                .attr("height", jwh)
                .append("svg:g"),
            map = canvas.append("svg:svg")
                .attr("id", "map")
                .attr("x", 0)
                .attr("width", jktw)
                .attr("height", jkth)
                .append("svg:g"),



        //Width and height for jabodetabek
            projectionFS = d3.geo.mercator()
                           .rotate([-106.33,5.9,0])//([-106.2,5.9,0])
                           .scale(width*37)//(width*15)
                           .translate([0, 0]),
            pathFS = d3.geo.path().projection(projectionFS),

            zoomFS = d3.behavior.zoom()
                .on("zoom", zoomedFS);

            map3.append("rect")
                .attr("id", "gjktFS_rect")
                .attr("class", "background")
                .attr("width", jktw)
                .attr("height", jkth+jwh);

            var gjktFS = map3.append("g")
                .attr("id", "gjktFS")
                .call(zoomFS);

        //Width and height for jabodetabek
            projection = d3.geo.mercator()
                           .rotate([-105.8,5.9,0])//([-106.2,5.9,0])
                           .scale(width*20)//(width*15)
                           .translate([0, 0]),
            path = d3.geo.path().projection(projection),

            zoom = d3.behavior.zoom()
                .on("zoom", zoomed);

            map.append("rect")
                .attr("id", "gjkt_rect")
                .attr("class", "background")
                .attr("width", jktw)
                .attr("height", jkth);

            var gjkt = map.append("g")
                .attr("id", "gjkt")
                .call(zoom);

        //Width and height for java island
        var projection2 = d3.geo.mercator()
                            .rotate([-105,5.7,0])
                            .scale(width*3.8)
                            .translate([0, 0]),
            path2 = d3.geo.path().projection(projection2),

            zoom2 = d3.behavior.zoom()
                .on("zoom", zoomed2);

            map2.append("rect")
                .attr("id", "gjw_rect")
                .attr("class", "background2")
                .attr("width", jww)
                .attr("height", jwh);

            var gjw = map2.append("g")
                .attr("id", "gjw")
                .call(zoom2);

        //global variable to store data movement csv
        var data = [],
            datadump = [],

            javjson = [],
            jakjson = [],
            cities = [],
            unique_areatarget = [],
            datamovjav = [],
            datamovjak = [],
            linksByOrigin = {},
            countByCity = {},
            locationByCity = {},
            positions = [],
            positions2 = [],
            minmaxvaljkt = [],
            minmaxvaljv = [],
            dt_lbm = [],

            originmenu = "",//F1
            collectormenu = "",//F2
            destinationmenu = "",//F3
            speciesmenu = [],//F4
            connectionmenu = "",//F5

            ljv1 = 0,
            ljv2 = 0,
            ljv3 = 0,
            ljv4 = 0,
            ljv5 = 0,
            ljkt1 = 0,
            ljkt2 = 0,
            ljkt3 = 0,
            ljkt4 = 0,
            ljkt5 = 0,

            JVForFilter,
            JVDvalueForFilter;	//global variabel to pass value from selected origin to filter

        var target = d3.select("#tooltip")
                .style("left", leftbuble+"px")
                .style("top", topbuble+"px")
                .style("width", widthbuble+"px")
                .style("height", heightbuble+"px");

        var startpoint = [],
            endpoint = [];

        var setNormalColor = function(d)
        {
            return "white";
        }

        var setJktColor = function(d)
        {
            //Get data total
            var totalweeklvolume =  d.properties.total ;

            if (totalweeklvolume)
            {

                if (totalweeklvolume <= ljkt2){return "#D1FFD5"}
                else if (totalweeklvolume <= ljkt3){return "#00FF1E"}
                else if (totalweeklvolume <= ljkt4){return "#828CFF"}
                else if (totalweeklvolume <= ljkt5){return "#0015FF"}
            }
            else
            {
                //If value is undefined…
                return "#FFFFFF"
            }
        }

        var setJktColorSDLBM = function(d)
        {
            //Get data total
            var totalweeklvolume =  d.total  ;

            if (totalweeklvolume)
            {

                if (totalweeklvolume <= ljkt2){return "#D1FFD5"}
                else if (totalweeklvolume <= ljkt3){return "#00FF1E"}
                else if (totalweeklvolume <= ljkt4){return "#828CFF"}
                else if (totalweeklvolume <= ljkt5){return "#0015FF"}
            }
            else
            {
                //If value is undefined…
                return "#FFFFFF"
            }
        }

        var setJavColor = function(d)
        {
            //Get data total
            var totalweeklvolume = d.properties.total;
            if (totalweeklvolume)
            {
                if (totalweeklvolume <= ljv2){return "#FCDF7E"}
                else if (totalweeklvolume <= ljv3){return "#FFC400"}
                else if (totalweeklvolume <= ljv4){return "#FF7D7D"}
                else if (totalweeklvolume <= ljv5){return "#FF0000"}
            }
            else
            {
                //If value is undefined…
                return "#FFFFFF"
            }
        }

        var setJavColorSDLBM = function(d)
        {
            //Get data total
            var totalweeklvolume =  d.properties.total  ;
            if (totalweeklvolume)
            {
                if (totalweeklvolume <= ljv2){return "#FCDF7E"}
                else if (totalweeklvolume <= ljv3){return "#FFC400"}
                else if (totalweeklvolume <= ljv4){return "#FF7D7D"}
                else if (totalweeklvolume <= ljv5){return "#FF0000"}
            }
            else
            {
                //If value is undefined…
                return "#FFFFFF"
            }
        }

        //function to get distinguish origin area
        var getOriginCity = function (d,selected)
        {
            var areaorigin = [];
            var n = 0;
            if (selected == "district")
            {
                var areaselected = d.properties.KAB_KOTA;

                for (var i = 0; i < data.length; i++)
                {
                    if (data[i].CY_district == areaselected)
                    {
                        areaorigin[n] = data[i].district_org_source;
                        n = n + 1;
                        //break;
                    }
                }
            }
            else if (selected == "subdistrict")
            {
                var areaselected = d.subdistrict;
                for (var i = 0; i < data.length; i++)
                {
                    if (data[i].CY_subdistrict == areaselected)
                    {
                        areaorigin[n] = data[i].district_org_source;
                        n = n + 1;
                        //break;
                    }
                }
            }
            else if (selected == "lbm")
            {
                var areaselected = d.marketCode;

                for (var i = 0; i < data.length; i++)
                {
                    if (data[i].cy_id_new == areaselected)
                    {
                        areaorigin[n] = data[i].district_org_source;
                        n = n + 1;
                        //break;
                    }
                }
            }


            //get unique data
            var unique_areaorigin = areaorigin.filter(function(item, pos)
            {
                return areaorigin.indexOf(item) == pos;
            });
            return unique_areaorigin;

        }

        var getDestCity = function (d,type)
        {

            var areadest = [];
            var areasd = [];
            var arealbm = [];
            var n = 0;
            var areaselected = d.district || d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

            for (var i = 0; i < data.length; i++)
            {
                if (data[i].district_org_source == areaselected)
                {
                    areadest[n] = data[i].CY_district;
                    areasd[n] = data[i].CY_subdistrict;
                    arealbm[n] = data[i].cy_id_new;
                    n = n + 1;
                    //break;
                }
            }

            //get unique data
            var unique_areadest = areadest.filter(function(item, pos)
            {
                return areadest.indexOf(item) == pos;
            });

            var unique_areasd = areasd.filter(function(item, pos)
            {
                return areasd.indexOf(item) == pos;
            });

            var unique_arealbm = arealbm.filter(function(item, pos)
            {
                return arealbm.indexOf(item) == pos;
            });
            if (type == "district"){return unique_areadest;}
            if (type == "subdistrict"){return unique_areasd;}
            if (type == "lbm"){return unique_arealbm;}
        }

        var getDistrictBasedOnMarketCode = function (d)
        {
            var dist = [];
            var n = 0;
            var lbmCodeSelected = d.marketCode;

            for (var i = 0; i < data.length; i++)
            {
                if (data[i].cy_id_new == lbmCodeSelected)
                {
                    dist[n] = data[i].CY_district;
                    d.district = data[i].CY_district;
                    n = n + 1;
                    //break;
                }
            }
            return d;
        }

        //function to print weekly volume information of the origin areas (JAVA MAP) based on selected destination (JKT MAP)
        var getInfoOrifromDest = function (d,selected)
        {
            if (selected == "district")
            {
                areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

                //return data with selected origin selection
                var databasedondest = data.filter(function(d)
                    {
                        return d.CY_district == areaselected && d.weekly_volume != 0;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.district_org_source })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return parseFloat(g.weekly_volume)});
                        })
                    .entries(databasedondest)
                datamovjak=datafilterbydistrictandspecies;
            }
            else if (selected == "subdistrict")
            {
                areaselected = d.subdistrict;

                //return data with selected origin selection
                var databasedondest = data.filter(function(d)
                    {
                        return d.CY_subdistrict == areaselected && d.weekly_volume != 0;
                    })

                var datafilterbySDandspecies = d3.nest()
                    .key(function(d){ return d.district_org_source })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedondest)
                datamovjakSD=datafilterbySDandspecies;
            }
            else if (selected == "lbm")
            {
                areaselected = d.marketCode;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.cy_id_new == areaselected && d.weekly_volume != 0;
                    })

                var datafilterbylbmandspecies = d3.nest()
                    .key(function(d){ return d.district_org_source })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedonorigin)
                datamovjakLBM=datafilterbylbmandspecies;
            }

        }

        var getInfoDestfromOri = function (d,selected)
        {
            if (selected == "district")
            {
                areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.district_org_source == areaselected && d.weekly_volume != 0;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.CY_district })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return parseFloat(g.weekly_volume)});
                        })
                    .entries(databasedonorigin)
                datamovjav=datafilterbydistrictandspecies;
            }
            else if (selected == "subdistrict")
            {
                areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.district_org_source == areaselected;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.CY_subdistrict })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedonorigin)
                datamovjavSD=datafilterbydistrictandspecies;

            }
            else if (selected == "lbm")
            {

                areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.district_org_source == areaselected;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.cy_id_new })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedonorigin)
                datamovjavLBM=datafilterbydistrictandspecies;
            }

        }

        var getInfoCY_SDnLBMfromCY_D = function (d,selected)
        {
            if (selected == "subdistrict" || selected == "sd+lbm" )
            {
                areaselected = d.properties.KAB_KOTA;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.CY_district == areaselected;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.CY_subdistrict })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedonorigin)
                datamovjakFSSD=datafilterbydistrictandspecies;
            }
            if (selected == "lbm" || selected == "sd+lbm")
            {

                areaselected = d.Name || d.properties.KAB_KOTA || d.properties.KABKOT;

                //return data with selected origin selection
                var databasedonorigin = data.filter(function(d)
                    {
                        return d.CY_district == areaselected;
                    })

                var datafilterbydistrictandspecies = d3.nest()
                    .key(function(d){ return d.cy_id_new })
                    .key(function(d){ return d.species })
                    .rollup(function(d)
                        {
                            return d3.sum(d, function (g){ return g.weekly_volume});
                        })
                    .entries(databasedonorigin)
                datamovjakFSLBM=datafilterbydistrictandspecies;
            }
        }

        var dt = function(dest,ori)
        {
            var result = [];
            var n = 0;
            for (var i = 0; i < ori.length; i++)
            {

                 var dataState = ori[i];
                 //Find the corresponding state inside the GeoJSON
                for (var j = 0; j < dest.features.length; j++)
                {
                    var jsonState = dest.features[j].properties.KAB_KOTA;
                    if (dataState == jsonState )
                    {
                        result[n] = dest.features[j];
                        n = n + 1;
                        break;
                    }
                }
            }
            return result
        };


/******************************** F U N C T I O N S ********************************/
        function getcsvdata()
        {
            //Get data from CSV file
            //The d3.csv() function does both the loading and the parsing without giving you a chance to intervene so we need to do this
            d3.xhr('Movement.csv').get(function (err, response)
            {
                // to delete the first row and get the header
                var dirtyCSV = response.responseText;
                var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
                data = d3.csv.parse(cleanCSV);
            })
        }

        function FSMapJKT(js)
        {
            if(map3.selectAll("path").empty()) {
                gjktFS.append("g")
                    .selectAll("path")
                    .data(js.features)
                    .enter()
                    .append("path")
                    .attr("d", pathFS)
                    .style("fill", setNormalColor)
                    .style("stroke", "rgb(0,109,44)")
                    .on("click", function(d)
                    {
                        //JVForFilter = (function () { return; })();
                        JKTFSForFilter = d3.select(this);
                        JKTFSDvalueForFilter = d;

                        JKTFS_path_onclick();
                    })
                    .on("dblclick", function(d){clicked(d,jktw,(jkth+jwh),gjktFS, pathFS, projectionFS, zoomFS)})
                    .on("mouseover", function(d)
                    {
                        var coordinates = [0, 0];
                            coordinates = d3.mouse(this);

                        var target2 = d3.select("#tooltip2")
                            .style("left", coordinates[0] + "px")
                            .style("top", coordinates[1] + (2*margin) + "px");

                        target2.select("#daerah").text("Destination : "+d.properties.KAB_KOTA+" - " + d.properties.PROPINSI);

                        //Show tooltip
                        d3.select("#tooltip2").classed("hidden", false);
                    })
                    .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});;

            } else {
                gjktFS.selectAll("path")
                    //.attr("fill", "none")
                    .style("fill", setJktColor)
                    .attr("stroke-width", 1);
                gjktFS.selectAll("path")
                    .data([js], function(d) { return d.properties.OBJECTID; })
                    .style("fill", "orange")
                    .attr("stroke-width", 2);
            }
        }

        function updateMapJKT(js)
        {
            if(map.selectAll("path").empty()) {
                gjkt.append("g")
                    .selectAll("path")
                    .data(js.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .style("fill", setNormalColor)
                    .style("stroke", "rgb(0,109,44)")
                    .on("click", function(d)
                    {
                        JVForFilter = (function () { return; })();
                        JKTForFilter = d3.select(this);
                        JKTDvalueForFilter = d;

                        JKT_path_onclick();
                    })
                    .on("dblclick", function(d){clicked(d,jktw,jkth,gjkt, path, projection, zoom)})
                    .on("mouseover", function(d)
                    {
                        var coordinates = [0, 0];
                            coordinates = d3.mouse(this);

                        var target2 = d3.select("#tooltip2")
                            .style("left", coordinates[0] + "px")
                            .style("top", coordinates[1] + (2*margin) + "px");

                        target2.select("#daerah").text("Destination : "+d.properties.KAB_KOTA+" - " + d.properties.PROPINSI);

                        //Show tooltip
                        d3.select("#tooltip2").classed("hidden", false);
                    })
                    .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});

            }
            else
            {
                map.selectAll("path")
                    .style("fill", setJktColor)
                    .attr("stroke-width", 1);
                map.selectAll("path")
                    .data([js], function(d){ return d.properties.OBJECTID; })
                    .style("fill", "orange")
                    .attr("stroke-width", 2);
            }
        }

        function updateMapJAVA(js)
        {
            if(map2.selectAll("path").empty()) {
                gjw.append("g").selectAll("path")
                   .data(js.features)
                   .enter()
                   .append("path")
                   .attr("d", path2)
                   .style("fill", setNormalColor)
                   .style("stroke", "rgb(0,109,44)")
                   .on("click", function(d)
                    {
                        JKTForFilter = (function () { return; })();
                        JVForFilter = d3.select(this);
                        JVDvalueForFilter = d;

                        JV_path_onclick()
                    })
                    .on("dblclick", function(d){clicked(d,jww,jwh,gjw, path2, projection2, zoom2)})
                    .on("mouseover", function(d)
                    {
                        var coordinates = [0, 0];
                            coordinates = d3.mouse(this);

                        var target2 = d3.select("#tooltip2")
                            .style("left", coordinates[0] + "px")
                            .style("top", coordinates[1] + (jkth + 4*margin) + "px");

                        target2.select("#daerah").text("Origin : "+d.properties.KAB_KOTA+" - " + d.properties.PROPINSI);

                        //Show tooltip
                        d3.select("#tooltip2").classed("hidden", false);
                    })
                    .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});

            } else {
                map2.selectAll("path")
                    //.attr("fill", "none")
                    .style("fill", setNormalColor)
                    .attr("stroke-width", 1);
                map2.selectAll("path")
                    .data([js[0]], function(d){return d.properties.OBJECTID;})
                    .style("fill", "orange")
                    .attr("stroke-width", 2);
            }
        }

        function clicked(d,w,h, gpath, p, proj, z)
        {
            var centroid = p.centroid(d),
              translate = proj.translate();

            proj.translate([
                translate[0] - centroid[0] + w / 2,
                translate[1] - centroid[1] + h / 2
            ]);

            z.translate(proj.translate());

            gpath.selectAll("path").transition()
              .duration(700)
              .attr("d", p);

            gpath.selectAll("circle")
                .transition()
                .duration(700)
                .attr("transform", function(d,i)
                {

                    return "translate("+proj.translate()+" )"
                })

            gpath.selectAll("rect")
                .transition()
                .duration(700)
                .attr("transform", function(d,i)
                {

                    return "translate("+proj.translate()+" )"
                })

            /*gpath.selectAll("text")
                .transition()
                .duration(700)
                .attr("transform", function(d,i)
                {

                    return "translate("+proj.translate()+" )"
                })*/
        }

        //zoom function for jkt
        function zoomedFS()
        {
            gjktFS.attr("transform","translate("+
                    d3.event.translate.join(",")+")scale("+d3.event.scale+")");
            gjktFS.selectAll("circle")
                .attr("d", pathFS.projection(projectionFS))
                .attr("r", 5/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });
            gjktFS.selectAll("rect")
                .attr("d", pathFS.projection(projectionFS))
                .attr("width", 10/zoom.scale())
                .attr("height", 10/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });
            gjktFS.selectAll("path")
                .attr("d", pathFS.projection(projectionFS));
            /*gjktFS.selectAll("text")
                .attr("d", pathFS.projection(projectionFS)); */
            map3.selectAll("#c_id")
                .attr("d", pathFS.projection(projectionFS))
                .attr("r", 5/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });
        }

        function zoomed()
        {
            gjkt.attr("transform","translate("+
                    d3.event.translate.join(",")+")scale("+d3.event.scale+")");
            gjkt.selectAll("circle")
                .attr("d", path.projection(projection))
                .attr("r", 5/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });
            gjkt.selectAll("rect")
                .attr("d", path.projection(projection))
                .attr("width", 10/zoom.scale())
                .attr("height", 10/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });
            gjkt.selectAll("path")
                .attr("d", path.projection(projection));
            /*gjkt.selectAll("text")
                .attr("d", path.projection(projection)); */
            map.selectAll("#c_id")
                .attr("d", path.projection(projection))
                .attr("r", 5/zoom.scale())
                .attr("stroke-width", function()
                {
                    if (zoom.scale()>4){return 0;}
                    else {return 1}
                });


        }

        //zoom function for Java
        function zoomed2()
        {
            gjw.attr("transform","translate("+d3.event.translate.join(",")+")scale("+d3.event.scale+")");
            gjw.selectAll("circle")
                .attr("d", path2.projection(projection2))
                .attr("r", 5/zoom.scale());
            gjw.selectAll("rect")
                .attr("d", path2.projection(projection2))
                .attr("width", 10/zoom.scale())
                .attr("height", 10/zoom.scale());
            gjw.selectAll("path")
                .attr("d", path2.projection(projection2));
            /*gjw.selectAll("text")
                .attr("d", path2.projection(projection2));*/
        }

        //generate the circles
        function showCity(cities, whmap, pt, color, type)
        {
            /* Define the data for the circles */
            var elem = whmap.selectAll(type)
                            .data(cities)

            /*Create and place the "blocks" containing the circle and the text */
            var elemEnter = elem.enter()
                .append("g")
                .attr("transform", function(d,i)
                {
                    return "translate("+pt[i][0]+","+pt[i][1]+" )"
                })

            if (type == "circle")
            {
                /*Create the circle for each block */
                var circle = elemEnter.append("circle")
                                        .style("stroke", "gray")
                                        .attr("stroke-width", 1)
                                        .style("fill", color)
                                        .attr("r", function(d,i)
                                        {
                                            if (connectionmenu[0] == "Size" || connectionmenu[1] == "Size" || connectionmenu[2] == "Size" )
                                            {
                                                return Math.sqrt(d.total/50); }
                                            else
                                            {
                                                return 5
                                            }
                                        })
                                        //.sort(function(a, b) { return countByCity[b.Name] - countByCity[a.Name]; })
                                        pt = [];
            }

            if (type == "rect")
            {
            /*Create the rect for each block */

                var rect = elemEnter.append("rect")
                                    .style("stroke", "gray")
                                    .attr("stroke-width", 1)
                                    .style("fill", color)
                                    .attr("height", function(d,i)
                                    {
                                        if (connectionmenu[0] == "Size" || connectionmenu[1] == "Size" || connectionmenu[2] == "Size" )
                                        {
                                            return Math.sqrt(d.total/50); }
                                        else
                                        {
                                            return 10
                                        }
                                    })
                                    .attr("width", function(d,i)
                                    {
                                        if (connectionmenu[0] == "Size" || connectionmenu[1] == "Size" || connectionmenu[2] == "Size" )
                                        {
                                            return Math.sqrt(d.total/50); }
                                        else
                                        {
                                            return 10
                                        }
                                    })
                                    //.sort(function(a, b) { return countByCity[b.Name] - countByCity[a.Name]; })
                                    pt = [];
            }


            /* Create the text for each block */
            /*elemEnter.append("text")
                    .text(function(d){
                        return d.subdistrict;})
                    .attr("dx", function(d){return 0})
                    .attr("dy", function(d){return 20})
                    .attr({
                          "alignment-baseline": "middle",
                          "text-anchor": "middle"
                        })*/

        }

        //show circles of lbm positions (on JKT Map: Color Red Circles)
        function lbmextraction(proj, shape, citycolor)
        {

            var poslbm = [];
            var arc = d3.geo.greatArc()
                  .source(function(d) { return locationByCity[d.source]; })
                  .target(function(d) { return locationByCity[d.target]; });

            data.forEach(function(deliver)
            {
                var origin = deliver.district_org_source,
                    destination = deliver.cy_id_new,
                    links = linksByOrigin[origin] || (linksByOrigin[origin] = []);

                links.push({source: origin, target: destination});
                countByCity[origin] = (countByCity[origin] || 0) + 1;
                countByCity[destination] = (countByCity[destination] || 0) + 1;
            });

            d3.csv("dest2lbm.csv", function(lbms)
            {

                lbms = lbms.filter(function(lbm)
                {
                    if (countByCity[lbm.marketCode])
                    {
                        var Lat = (-1*lbm.LS_Coord_Deg) - (+lbm.LS_Coord_Min/100),
                        Long = (1*lbm.BT_Coord_Deg) + (+lbm.BT_Coord_Min/100),
                        locationlbm = [+Long, +Lat];
                        lbm.location = locationlbm
                        locationByCity[lbm.name] = locationlbm;
                        poslbm.push(proj(locationlbm));

                        return true;
                    }

                });

                var g = shape.selectAll("g")
                    .data(lbms)
                    //.enter()
                    .append("svg:g");

                //generate the circles
                showCity(lbms,shape,poslbm,citycolor,"rect");

                shape.selectAll("rect")
                    .on("click", function(JVDvalueForFilter)
                    {
                        var rectselected = d3.select(this);
                        JKT_rect_onclick(rectselected,JVDvalueForFilter);
                    })
                    .on("mouseover", function(d)
                    {
                        var coordinates = [0, 0];
                            coordinates = d3.mouse(this);

                        var target2 = d3.select("#tooltip2")
                            .style("left", coordinates[0] + (7*margin) + "px")
                            .style("top", coordinates[1] + (7*margin) + "px");

                        target2.select("#daerah").text("Destination : "+d.name);

                        //Show tooltip
                        d3.select("#tooltip2").classed("hidden", false);

                    })
                    .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});

            });
        };

        //show circles of subdistrict positions (on JKT Map: Color Blue Circles)
        function subdistrictextraction(proj, shape, citycolor)
        {
            var possd=[];
            var arc = d3.geo.greatArc()
                  .source(function(d) { return locationByCity[d.source]; })
                  .target(function(d) { return locationByCity[d.target]; });

            data.forEach(function(deliver)
            {
                var origin = deliver.district_org_source,
                    destination = deliver.CY_subdistrict,
                    links = linksByOrigin[origin] || (linksByOrigin[origin] = []);

                links.push({source: origin, target: destination});
                countByCity[origin] = (countByCity[origin] || 0) + 1;
                countByCity[destination] = (countByCity[destination] || 0) + 1;
            });

            d3.csv("dest1dki.csv", function(sds)
            {
                // Only consider cities with at least one deliver.
                sds = sds.filter(function(sd)
                {

                    if (countByCity[sd.subdistrict])
                    {
                        var Lat = (-1*sd.gps_north_degree) - (+sd.gps_north_minute/100),
                        Long = (1*sd.gps_east_degree) + (+sd.gps_east_minute/100),
                        location = [+Long, +Lat];
                        sd.location = location;
                        locationByCity[sd.subdistrict] = location;
                        possd.push(proj(location));
                        return true;
                    }
                });

                var g = shape.selectAll("g")
                    .data(sds)
                    //.enter()
                    .append("svg:g");


                //generate the circles
                showCity(sds,shape,possd,citycolor, "circle");

                shape.selectAll("circle")
                .on("click", function(JVDvalueForFilter)
                {
                    var circleselected = d3.select(this);
                    JKT_circle_onclick(circleselected,JVDvalueForFilter)
                })
                .on("mouseover", function(d)
                {
                    var coordinates = [0, 0];
                        coordinates = d3.mouse(this);

                    var target2 = d3.select("#tooltip2")
                        .style("left", coordinates[0] + (7*margin) + "px")
                        .style("top", coordinates[1] + (7*margin) + "px");

                    target2.select("#daerah").text("Destination : "+d.subdistrict);

                    //Show tooltip
                    d3.select("#tooltip2").classed("hidden", false);

                })
                .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});

            });
        };

        // The table generation function for non-nested table
        function tabulate(data, columns)
        {
            var table = canvas.append("foreignObject")
                .attr("x", width - 4*margin - 250)
                .attr("y", 4*margin)
                .attr("width", 250)
                .attr("height",height-5*margin)
            .append("xhtml:body")
                    .append("table")
                    .attr("class", "tblinfo")
                    .attr("style", "margin-left: 0px"),
                thead = table.append("thead"),
                tbody = table.append("tbody");

            // append the header row
            thead.append("tr")
                .selectAll("th")
                .data(columns)
                .enter()
                .append("th")
                    .text(function(column)
                    {
                        if (column == "CY_district"){column = "Area Destination"}
                        if (column == "district_org_source"){column = "Area Origin"}
                        if (column == "tot"){column = "Total Weekly Volume"}
                        if (column == "species"){column = "Bird Species"}

                        return column;
                    });

            // create a row for each object in the data
            var rows = tbody.selectAll("tr")
                .data(data)
                .enter()
                .append("tr");

            // create a cell in each row for each column
            var cells = rows.selectAll("td")
                .data(function(row) {
                    return columns.map(function(column) {
                        return {column: column, value: row[column]};
                    });
                })
                .enter()
                .append("td")
                .attr("style", "font-family: Courier") // sets the font style
                    .html(function(d) { return d.value; });

            return table;
        }

        // The table generation function foe nested tabel
        function tabulate2(data)
        {
            var table = canvas.append("foreignObject")
                            .attr("x", jktw + (2*margin))
                            .attr("y", 10*margin)
                            //.attr("width", 300)
                            //.attr("height",height-5*margin)
                            .append("xhtml:body")
                            .append("div")
                            .attr("class", "outer")
                            .attr("style","width:" + outermargin +"px")
                            .append("div")
                            .attr("class", "inner")
                            .attr("style","width:" + innermargin +"px")
                            .append("div")
                            .attr("id", "InfoTab")
                            .selectAll("table")
                            .data([data])
                            .enter().append("table")
                            .call(recurse);
            return table;
        }

        //added title and other information for the interfaces
        function titleinterface()
        {
            svg.append("svg:text")
                .classed("title", true)
                .attr("text-anchor", "start")
                .attr("x", 1.5*margin)
                .attr("y", 1*margin)
                .text("Movement Tool: Connections of Collectors, Live Bird Markets and district of origin for live birds traded in JABODETABEK ")
                .attr("width", jktw);
            svg.append("svg:text")
                .attr("text-anchor", "start")
                .attr("y", height-5)
                .text("Spreading birds data 2015");
            svg.append("svg:text")
                .attr("text-anchor", "end")
                .attr("x", width)
                .attr("y", height-5)
                .text("@Urremote.com 2015");
        }

        //create legend bar
        function legendinJava()
        {
            var legendjv = canvas.append("g").attr("id", "legendJV")
            legendjv.append("svg:rect")
                .attr("id", "ljvb5")
                .attr("fill", "#FF0000")
                .attr("x", margin)
                .attr("y", jkth+jwh-6*marginforlegend-8)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjv.append("svg:rect")
                .attr("id", "ljvb4")
                .attr("fill", "#FF7D7D")
                .attr("x", margin)
                .attr("y", jkth+jwh-5*marginforlegend-6)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjv.append("svg:rect")
                .attr("id", "ljvb3")
                .attr("fill", "#FFC400")
                .attr("x", margin)
                .attr("y", jkth+jwh-4*marginforlegend-4)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjv.append("svg:rect")
                .attr("id", "ljvb2")
                .attr("fill", "#FCDF7E")
                .attr("x", margin)
                .attr("y", jkth+jwh-3*marginforlegend-2)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjv.append("svg:rect")
                .attr("id", "ljvb1")
                .attr("fill", "#FFFFFF")
                .attr("x", margin)
                .attr("y", jkth+jwh-2*marginforlegend)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("transform", "translate("+(margin - 5)+","+(jkth+jwh-1*marginforlegend)+") rotate("+270+")")
                .text("Weekly Volume")

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv5")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-5*marginforlegend-10) + ")")
                .text("31 - 40")

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv4")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-4*marginforlegend-6) + ")")
                .text("21 - 30")

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv3")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-3*marginforlegend-4) + ")")
                .text("11 - 20")

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv2")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-2*marginforlegend-2) + ")")
                .text("1 - 10")

            legendjv.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv1")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-marginforlegend) + ")")
                .text("0")
        }

        function legendRepJava()
        {
            var legendjvR = canvas.append("g").attr("id", "legendJVR")

            legendjvR.append("svg:rect")
                .attr("fill", "purple")
                .attr("x", margin)
                .attr("y", jkth+jwh-2*marginforlegend)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjvR.append("svg:text")
                .classed("expl", true)
                .attr("transform", "translate("+(margin - 5)+","+(jkth+jwh-1*marginforlegend)+") rotate("+270+")")
                .text("Origin Selected")

            legendjvR.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljv1R")
                .attr("transform", "translate("+ (2*margin-marginforlegend+5) +"," + (jkth+jwh-marginforlegend) + ")")

        }

        function legendinJak()
        {
            var legendjkt = canvas.append("g").attr("id", "legendJKT")
            legendjkt.append("svg:rect")
                .attr("id", "ljktb5")
                .attr("fill", "#0015FF")
                .attr("x", jktx+margin)
                .attr("y", 7)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjkt.append("svg:rect")
                .attr("id", "ljktb4")
                .attr("fill", "#828CFF")
                .attr("x", jktx+margin)
                .attr("y", 1*marginforlegend+9)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjkt.append("svg:rect")
                .attr("id", "ljktb3")
                .attr("fill", "#00FF1E")
                .attr("x", jktx+margin)
                .attr("y", 2*marginforlegend+11)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjkt.append("svg:rect")
                .attr("id", "ljktb2")
                .attr("fill", "#D1FFD5")
                .attr("x", jktx+margin)
                .attr("y", 3*marginforlegend+13)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjkt.append("svg:rect")
                .attr("id", "ljktb1")
                .attr("fill", "#FFFFFF")
                .attr("x", jktx+margin)
                .attr("y", 4*marginforlegend+15)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("transform", "translate("+(jktx+margin - 5)+","+(7*marginforlegend+8)+") rotate("+270+")")
                .text("Weekly Volume")

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt5")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (1*marginforlegend+6) + ")")
                .text("31 - 40")

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt4")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (2*marginforlegend+7) + ")")
                .text("21 - 30")

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt3")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (3*marginforlegend+9) + ")")
                .text("11 - 20")

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt2")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (4*marginforlegend+11) + ")")
                .text("1 - 10")

            legendjkt.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt1")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (5*marginforlegend+15) + ")")
                .text("0")

        }

        function legendRepJak()
        {
            var legendjktR = canvas.append("g").attr("id", "legendJKTR")

            legendjktR.append("svg:rect")
                .attr("fill", "orange")
                .attr("x", jktx+margin)
                .attr("y", 7)
                .attr("width", marginforlegend)
                .attr("height", marginforlegend);//height - h2 - 5*margin);

            legendjktR.append("svg:text")
                .classed("expl", true)
                .attr("transform", "translate("+(jktx+margin - 5)+","+(9*marginforlegend+8)+") rotate("+270+")")
                .text("Destination Selected")

            legendjktR.append("svg:text")
                .classed("expl", true)
                .attr("id", "ljkt1R")
                .attr("transform", "translate("+ (jktx+(2*margin-marginforlegend+5)) +"," + (1*marginforlegend+6) + ")")


        }

        //load filter options
        function Filter1_Origins()
        {
            var dispatch = d3.dispatch("load", "originschange");
            var dtddm1 = ["District"];

            d3.xhr("Movement.csv").get(function ()
            {
                var dtddm1ById = d3.map();
                dtddm1.forEach(function (d)
                {
                    dtddm1ById.set(d, d);
                });
                dispatch.load(dtddm1ById);
                dispatch.originschange(dtddm1ById.get("District"));
            });

            dispatch.on("load.menu", function(dtddm1)
            {
                var select = svg.append("foreignObject")
                        .attr("x", 1.5*margin)
                        .attr("y", 2*margin)
                        .attr("width", filterwidth)
                        .attr("height",100)
                        .append("xhtml:body")
                        .append("div")
                        .attr("id", "f1")
                        .text("ORIGINS: ")
                        .append("select")
                        //.attr("multiple","multiple")
                        .on("change", function ()
                        {
                            dispatch.originschange(dtddm1.get(this.value));
                        });

                select.selectAll("option")
                        .data(dtddm1.values())
                        .enter()
                        .append("option")
                        .attr("value", function (d) { return d; })
                        .text(function (d)
                        {
                            return d;
                        });

                dispatch.on("originschange.menu", function (val)
                {
                    select.property("value", val)
                    //if (typeof val != 'undefined')
                    //{
                        originmenu = val;
                    //}
                    // set new csv data based on filter from dropdownmenu1 value(ddm1value)
                    datafilterspecies(originmenu, collectormenu, destinationmenu, speciesmenu, connectionmenu)

                });
            });
            //end of drop down
        }

        function Filter2_Collectors()
        {
            var dispatch = d3.dispatch("load2", "collectorsschange");
            var dtddm2 = ["District","SubDistrict","LBM"];

            d3.xhr("Movement.csv").get(function ()
            {
                var dtddm2ById = d3.map();
                dtddm2.forEach(function (d)
                {
                    dtddm2ById.set(d, d);
                });
                dispatch.load2(dtddm2ById);
                dispatch.collectorsschange(dtddm2ById.get("All Dest"));
            });

            dispatch.on("load2.menu", function(dtddm2ById)
            {
                var select = svg.append("foreignObject")
                        .attr("x", 1.5*margin+1*filterwidth-40)
                        .attr("y", 2*margin)
                        .attr("width", filterwidth+60)
                        .attr("height",100)
                        .append("xhtml:body")
                        .append("div")
                        .attr("id", "f2")
                        .text("COLLECT: ")
                        .attr("style","vertical-align: top")
                        .append("select")
                        .attr("style","vertical-align: top")
                        .attr("multiple","multiple")
                        .attr("size",3)
                        .on("change", function ()
                        {
                            dispatch.collectorsschange(dtddm2ById.get(this.value));
                        });

                select.selectAll("option")
                        .data(dtddm2ById.values())
                        .enter()
                        .append("option")
                        .attr("value", function (d) { return d; })
                        .text(function (d)
                        {
                            return d;
                        });

                dispatch.on("collectorsschange.menu", function (val)
                {
                    //select.property("value", val)
                    collectormenu = [];
                    var spec = select
                        .selectAll("option")
                        .filter(function (d, i) {
                            return this.selected;
                        });
                    var datelegth = spec[0].length
                    if (datelegth != 0)
                    {
                        for (var j = 0; j < spec[0].length; j++)
                        {
                            collectormenu[j] = spec[0][j]['value'];
                        }
                    }
                    // set new csv data based on filter from dropdownmenu1 value(ddm1value)
                    datafiltercollector(collectormenu)

                });
            });
            //end of drop down
        }

        function Filter3_Destinations()
        {
            var dispatch = d3.dispatch("load3", "destinationschange");
            var dtddm3 = ["District","SubDistrict", "LBM"];

            d3.xhr("Movement.csv").get(function ()
            {
                var dtddm3ById = d3.map();
                dtddm3.forEach(function (d)
                {
                    dtddm3ById.set(d, d);
                });
                dispatch.load3(dtddm3ById);
                dispatch.destinationschange(dtddm3ById.get("District","SubDistrict", "LBM"));
            });

            dispatch.on("load3.menu", function(dtddm3ById)
            {
                var select = svg.append("foreignObject")
                        .attr("x", 1.5*margin+2*filterwidth-5)
                        .attr("y", 2*margin)
                        .attr("width", filterwidth+50)
                        .attr("height",100)
                        .append("xhtml:body")
                        .append("div")
                        .attr("id", "f3")
                        .text("DEST : ")
                        .attr("style","vertical-align: top")
                        .append("select")
                        .attr("style","vertical-align: top")
                        .attr("multiple","multiple")
                        .attr("size",3)
                        .on("change", function ()
                        {
                            dispatch.destinationschange(dtddm3ById.get(this.value));
                        });

                select.selectAll("option")
                        .data(dtddm3ById.values())
                        .enter()
                        .append("option")
                        .attr("value", function (d) { return d; })
                        .text(function (d)
                        {
                            return d;
                        });

                dispatch.on("destinationschange.menu", function (val)
                {
                    //select.property("value", val)
                    destinationmenu = [];
                    var spec = select
                        .selectAll("option")
                        .filter(function (d, i) {
                            return this.selected;
                        });
                    var datelegth = spec[0].length
                    if (datelegth != 0)
                    {
                        for (var j = 0; j < spec[0].length; j++)
                        {
                            destinationmenu[j] = spec[0][j]['value'];
                        }
                    }
                    // set new csv data based on filter from dropdownmenu1 value(ddm1value)
                    datafilterdest(destinationmenu)
                });
            });
            //end of drop down
        }

        function Filter4_Species()
        {
            var dispatch = d3.dispatch("load4", "specieschange");
            //var ALL = {species:"All Species"};

            d3.xhr('Movement.csv').get(function (err, response)
            {
                // to delete the first row and get the header
                var dirtyCSV = response.responseText;
                var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
                data = d3.csv.parse(cleanCSV);
                var speciesById = d3.map();
                //speciesById.set(ALL.species, ALL);
                data.forEach(function (d)
                {
                    speciesById.set(d.species, d);
                });
                dispatch.load4(speciesById);
                dispatch.specieschange(speciesById.get("All Species"));

            });

            dispatch.on("load4.menu", function(speciesById)
            {
                var select = svg.append("foreignObject")
                        .attr("x", 1.5*margin+3*filterwidth)
                        .attr("y", 2*margin)
                        .attr("width", filterwidth)
                        .attr("height",100)
                        .append("xhtml:body")
                        .append("div")
                        .attr("id", "f4")
                        .text("SPECIES : ")
                        .attr("style","vertical-align: top")
                        .append("select")
                        .attr("style","vertical-align: top")
                        .attr("multiple","multiple")
                        .attr("size",5)
                        .on("change", function ()
                        {
                            dispatch.specieschange(speciesById.get(this.value));
                        });

                select.selectAll("option")
                        .data(speciesById.values())
                        .enter()
                        .append("option")
                        .attr("value", function (d) { return d.species; })
                        .text(function (d)
                        {
                            return d.species;
                        });

                dispatch.on("specieschange.menu", function (val)
                {
                    //select.property("value", val.species)
                    speciesmenu = [];
                    var spec = select
                        .selectAll("option")
                        .filter(function (d, i) {
                            return this.selected;
                        });
                    var datelegth = spec[0].length
                    if (datelegth != 0)
                    {
                        for (var j = 0; j < spec[0].length; j++)
                        {
                            speciesmenu[j] = spec[0][j]['value'];
                        }

                    }


                    /*
                    select.selectAll("option")
                        .filter(function (d, i)
                        {
                            return this.selected;
                        });
                    */
                    //if (typeof val != 'undefined')
                    //{
                        //speciesmenu = val.species;
                    //}
                    // set new csv data based on filter from dropdownmenu1 value(ddm1value)
                    datafilterspecies(originmenu, collectormenu, destinationmenu, speciesmenu, connectionmenu)



                });
            });
            //end of drop down
        }

        function Filter5_Connections()
        {
            var dispatch = d3.dispatch("load5", "connectionschange");
            var dtddm5 = ["Color", "Line", "Size"];

            d3.xhr("Movement.csv").get(function ()
            {
                var dtddm5ById = d3.map();
                dtddm5.forEach(function (d)
                {
                    dtddm5ById.set(d, d);
                });
                dispatch.load5(dtddm5ById);
                dispatch.connectionschange(dtddm5ById.get("Line"));
                connectionmenu[0] = "Line";
            });

            dispatch.on("load5.menu", function(dtddm5ById)
            {
                var select = svg.append("foreignObject")
                        .attr("x", 1.5*margin+4*filterwidth)
                        .attr("y", 2*margin)
                        .attr("width", filterwidth+20)
                        .attr("height",100)
                        .append("xhtml:body")
                        .append("div")
                        .attr("id", "f1")
                        .text("CONNECT : ")
                        .attr("style","vertical-align: top")
                        .append("select")
                        .attr("style","vertical-align: top")
                        .attr("multiple","multiple")
                        .attr("size",3)
                        .on("change", function ()
                        {
                            dispatch.connectionschange(dtddm5ById.get(this.value));
                        });

                select.selectAll("option")
                        .data(dtddm5ById.values())
                        .enter()
                        .append("option")
                        .attr("value", function (d) { return d; })
                        .text(function (d)
                        {
                            return d;
                        });


                dispatch.on("connectionschange.menu", function (val)
                {
                    //select.property("value", val)
                    connectionmenu = [];
                    var spec = select
                        .selectAll("option")
                        .filter(function (d, i) {
                            return this.selected;
                        });
                    var datelegth = spec[0].length
                    if (datelegth != 0)
                    {
                        for (var j = 0; j < spec[0].length; j++)
                        {
                            connectionmenu[j] = spec[0][j]['value'];
                        }
                    }
                    // set new csv data based on filter from dropdownmenu1 value(ddm1value)
                    datafilterconn(connectionmenu)
                });
            });
            //end of drop down
        }

        //function filter for collector
        function datafiltercollector(collector)
        {
            JV_unselected_state

            //gjkt.selectAll("circle").remove();
            //gjkt.selectAll("rect").remove();

            if (collector == "District")
            {
                //do nothing
            }
            else if (collector == "SubDistrict")
            {
                //subdistrictextraction(projection, gjkt, setJktColorSDLBM)//"blue")
            }
            else if (collector == "LBM")
            {
                //lbmextraction(projection, gjkt, setJktColorSDLBM)//"red")
            }
            else
            {
                //lbmextraction(projection, gjkt, setJktColorSDLBM)//"red")
                //subdistrictextraction(projection, gjkt, setJktColorSDLBM)//"blue")
            }


        }

        //function filter for destination
        function datafilterdest(destination)
        {
            if (typeof JVForFilter != 'undefined')
            {
                JV_path_onclick();
            }
        }

        //function filter for species
        function datafilterspecies(origin, collector, destination, species, connection)
        {
            //reset data variable into original data
            data = datadump;

            if (species.length != 0)
            {
                var datafilterspecies = [];
                var n = 0;
                for (var j = 0; j < species.length; j++)
                {
                    var selectedspecies = species[j];
                    for (var i = 0; i < data.length; i++)
                    {
                        if (data[i].species == selectedspecies )
                        {
                            datafilterspecies[n] = data[i];
                            n = n + 1;
                            //break;
                        }
                    };

                }

                data = datafilterspecies;

                if (typeof JVForFilter != 'undefined')
                {
                    JV_path_onclick();
                }

                if (typeof JKTForFilter != 'undefined')
                {
                    JKT_path_onclick();
                }

            }

        }

        function datafilterconn(connection)
        {
            //console.log(connection)
        }

        //Store original data for reset function
        function datdum()
        {
            d3.xhr('Movement.csv').get(function (err, response)
            {
                //if (error) throw error;
                var dirtyCSV = response.responseText;
                var cleanCSV = dirtyCSV.split('\n').slice(1).join('\n');
                datadump = d3.csv.parse(cleanCSV);

            });
        }

        //additional function to generate tabular2
        function recurse(sel)
        {
            // sel is a d3.selection of one or more empty tables
            sel.each(function(d) {
            // d is an array of objects
            var colnames,
                tds,
                table = d3.select(this);

            // obtain column names by gathering unique key names in all 1st level objects
            // following method emulates a set by using the keys of a d3.map()
            colnames = d                                                          // array of objects
                .reduce(function(p,c) { return p.concat(d3.keys(c)); }, [])       // array with all keynames
                .reduce(function(p,c) { return (p.set(c,0), p); }, d3.map())      // map with unique keynames as keys
                .keys();                                                          // array with unique keynames (arb. order)

            // colnames array is in arbitrary order
            // sort colnames here if required

            // create header row using standard 1D data join and enter()
            table.append("thead").append("tr").selectAll("th")
                .data(colnames)
                .enter()
                .append("th")
                .text(function(d) //.text(function(d) { return d; });
                    {
                        if (d == "species"){d = "Species"}
                        if (d == "dest_and_tot"){d = "Destination and Total"}
                        if (d == "spec_and_tot"){d = "Detail"}
                        if (d == "dest")
                        {
                            if (destinationmenu[0] == "District" || typeof destinationmenu[0] == 'undefined')
                            {
                                d = "Destination (District)"
                            }
                            else if (destinationmenu[0] == "SubDistrict" )
                            {
                                d = "Destination   (Sub District)"
                            }
                            else if (destinationmenu[0] == "LBM")
                            {
                                d = "Destination (LBM)"
                            }

                        }
                        if (d == "ori"){d = "Origin"}
                        if (d == "tot_week_vol"){d = "Weekly Volume"}
                        if (d == "total"){d = "Total Weekly Volume"}

                        return d;
                    });

            // create the table cells by using nested 2D data join and enter()
            tds = table.append("tbody").selectAll("tr")
                .data(d)                            			// each row gets one object
                .enter()
                .append("tr")
                .selectAll("td")
                .data(function(d)
                    {                 							// each cell gets one value
                        return colnames.map(function(k)
                        {										// for each colname (i.e. key) find the corresponding value
                            return d[k] || "";              	// use empty string if key doesn't exist for that object
                        });
                    })
                .enter()
                .append("td");

            // cell contents depends on the data bound to the cell
            // fill with text if data is not an Array
            tds.filter(function(d) { return !(d instanceof Array); })
                .text(function(d) { return d; });
            // fill with a new table if data is an Array
            tds.filter(function(d) { return (d instanceof Array); })
                .append("table")
                .call(recurse);
            });
        }

        //function to convert the "key" and "values"
        function DataConverter (dataori,type,model)//type = {"ori to dest", "dest to ori"}| model = {"district","subdistrict","LBM"}
        {
            for (var i = 0; i < dataori.length; i++)

            {
                dataori[i].species = dataori[i].key;
                dataori[i].dest_and_tot = dataori[i].values;
                for (var j = 0; j < dataori[i].values.length; j++)
                {
                    dataori[i].dest_and_tot[j].dest = dataori[i].values[j].key;
                    dataori[i].dest_and_tot[j].tot_week_vol = dataori[i].values[j].values;
                    delete 	dataori[i].values[j].key;
                    delete dataori[i].values[j].values;
                }
                delete dataori[i].key;
                delete dataori[i].values;
            };
            return dataori;
        }

        //function to convert the "key" and "values"
        function DataConverter2 (dataori,type,model)//type = {"ori to dest", "dest to ori"}| model = {"district","subdistrict","LBM"}
        {
            for (var i = 0; i < dataori.length; i++)

            {
                if (type == "ori_to_dest"){dataori[i].dest = dataori[i].key;}
                if (type == "dest_to_ori"){dataori[i].ori = dataori[i].key;}
                dataori[i].spec_and_tot = dataori[i].values;
                for (var j = 0; j < dataori[i].values.length; j++)
                {
                    dataori[i].spec_and_tot[j].species = dataori[i].values[j].key;
                    if (dataori[i].values[j].values != 0)
                    dataori[i].spec_and_tot[j].tot_week_vol = dataori[i].values[j].values;
                    delete 	dataori[i].values[j].key;
                    delete dataori[i].values[j].values;
                }
                delete dataori[i].key;
                delete dataori[i].values;
            };
            return dataori;
        }

        function deviderLegend(minmaxval,peta)
        {
            var legVal = []
            if (minmaxval[0] != minmaxval[1])
            {
                d3.select("#ljv3").classed("hidden", false);
                d3.select("#ljv4").classed("hidden", false);
                d3.select("#ljv5").classed("hidden", false);
                d3.select("#ljkt3").classed("hidden", false);
                d3.select("#ljkt4").classed("hidden", false);
                d3.select("#ljkt5").classed("hidden", false);
                d3.select("#ljvb3").classed("hidden", false);
                d3.select("#ljvb4").classed("hidden", false);
                d3.select("#ljvb5").classed("hidden", false);
                d3.select("#ljktb3").classed("hidden", false);
                d3.select("#ljktb4").classed("hidden", false);
                d3.select("#ljktb5").classed("hidden", false);
                for (var i = 1; i < 5; i++)
                {
                    legVal[4-i] = Math.round(minmaxval[0]+((minmaxval[1]-minmaxval[0]) - (((minmaxval[1]-minmaxval[0])/4)*i)));
                }
            }
            else if (minmaxval[0] == 0 && minmaxval[1] == 0 || typeof minmaxval[0] == 'undefined' && typeof minmaxval[1] == 'undefined')
            {
                d3.select("#legendJKT").classed("hidden", true);
                d3.select("#legendJV").classed("hidden", true);
            }
            else
            {
                legVal[0] = "1";
                legVal[1] = minmaxval[1];
                d3.select("#ljv3").classed("hidden", true);
                d3.select("#ljv4").classed("hidden", true);
                d3.select("#ljv5").classed("hidden", true);
                d3.select("#ljkt3").classed("hidden", true);
                d3.select("#ljkt4").classed("hidden", true);
                d3.select("#ljkt5").classed("hidden", true);
                d3.select("#ljvb3").classed("hidden", true);
                d3.select("#ljvb4").classed("hidden", true);
                d3.select("#ljvb5").classed("hidden", true);
                d3.select("#ljktb3").classed("hidden", true);
                d3.select("#ljktb4").classed("hidden", true);
                d3.select("#ljktb5").classed("hidden", true);
            }

            if(peta == "JV" )
            {
                d3.select("#ljv1").text("0");
                d3.select("#ljv2").text(legVal[0]+" - "+legVal[1]);
                d3.select("#ljv3").text(legVal[1]+1+" - "+legVal[2]);
                d3.select("#ljv4").text(legVal[2]+1+" - "+legVal[3]);
                d3.select("#ljv5").text(legVal[3]+1+" - "+minmaxval[1]);

                ljv1 = legVal[0];
                ljv2 = legVal[1];
                ljv3 = legVal[2];
                ljv4 = legVal[3];
                ljv5 = minmaxval[1];

            }
            if(peta == "JKT")
            {
                d3.select("#ljkt1").text("0");
                d3.select("#ljkt2").text(legVal[0]+" - "+legVal[1]);
                d3.select("#ljkt3").text(legVal[1]+1+" - "+legVal[2]);
                d3.select("#ljkt4").text(legVal[2]+1+" - "+legVal[3]);
                d3.select("#ljkt5").text(legVal[3]+1+" - "+minmaxval[1]);

                ljkt1 = legVal[0];
                ljkt2 = legVal[1];
                ljkt3 = legVal[2];
                ljkt4 = legVal[3];
                ljkt5 = minmaxval[1];
            }
        }

        function addTotalField(data)
        {
            for (var i = 0; i < data.length; i++)
            {
                var total = 0;
                for (var j = 0; j < data[i].spec_and_tot.length; j++)
                {
                    total = total + data[i].spec_and_tot[j].tot_week_vol;
                }
                data[i].total = +total
            }
            return data;
        }

        function addTotalSendOrReceive(data)
        {

            var total = 0;
            for (var i = 0; i < data.length; i++)
            {
                for (var j = 0; j < data[i].spec_and_tot.length; j++)
                {
                    total = total + data[i].spec_and_tot[j].tot_week_vol;
                }
            }
            return +total;
        }

        function getMaxTot(d)
        {
            dvalue = [];
            d.forEach(function(datvalue,i)
            {
                dvalue[i] = datvalue.total;
            })


            var minmaxval = []
            minmaxval[0] = d3.min(dvalue);
            minmaxval[1] = d3.max(dvalue);
            return minmaxval

        }

        function getMaxTotNested(datamov)
        {
            // function for looking min max based on dest and species
            var minmaxval = []
            minmaxval[1] = d3.max(d3.entries(datamov), function(d) {
              return d3.max(d3.entries(d.value), function(e) {
                  return d3.max(e.value, function(f) { return f.tot_week_vol; });
              });
            });


            minmaxval[0] = d3.min(d3.entries(datamov), function(d) {
              return d3.min(d3.entries(d.value), function(e) {
                  return d3.min(e.value, function(f) { return f.tot_week_vol; });
              });
            });

            return minmaxval

        }

        function JV_unselected_state(d)
        {
            d3.select("#tooltip").classed("hidden", true);

            map.selectAll("path")
                .style("fill", setNormalColor)
                .attr("stroke-width", 1);

            map2.selectAll("path")
                .style("fill", setNormalColor)
                .attr("stroke-width", 1);

            map3.selectAll("path")
                .style("fill", setNormalColor)
                .attr("stroke-width", 1);

            d3.select("table").remove();
        }

        function JVJKT_legend_set(mapfocus)
        {
            if(d3.select("#legendJKT").empty()){legendinJak();}
            if(d3.select("#legendJKTR").empty()){legendRepJak();}
            if(d3.select("#legendJV").empty()){legendinJava();}
            if(d3.select("#legendJVR").empty()){legendRepJava();}
            if (mapfocus=="JV")
            {
                d3.select("#legendJKT").classed("hidden", false);
                d3.select("#legendJKTR").classed("hidden", true);
                d3.select("#legendJV").classed("hidden", true);
                d3.select("#legendJVR").classed("hidden", false);
            }
            if (mapfocus=="JKT")
            {
                d3.select("#legendJKT").classed("hidden", true);
                d3.select("#legendJKTR").classed("hidden", false);
                d3.select("#legendJV").classed("hidden", false);
                d3.select("#legendJVR").classed("hidden", true);
            }
        }

        function JKT_circle_onclick(sel_this, d)
        {

            //returned all circles default colour
            gjkt.selectAll("circle").style("fill", setJktColorSDLBM)

            JV_unselected_state(d);

            /* generate select-self SD position and Bubble text */
            sel_this.style("fill", "orange");

            d3.selectAll("#c_id").remove();
            d3.selectAll("#line_id").remove();
            if (connectionmenu[0] == "Line")
            {
                //startpoint = getCentroid(sel_this);
                generateCentralDistrict(this,gjkt)
            }

            target.select("#daerah").text("DEST Subdistrict :"+d.subdistrict);

            //Show tooltip
            d3.select("#tooltip").classed("hidden", false);

            var totalreceive = 0;
            /* generate legend */
            JVJKT_legend_set("JKT");

            /* generate table info */
            getInfoOrifromDest(d,"subdistrict")
            var datamovjakSDconvert = DataConverter2(datamovjakSD,"dest_to_ori","subdistrict");
            var datamovjakSDconvertaddtot = addTotalField(datamovjakSDconvert);
            totalreceiveSD = addTotalSendOrReceive(datamovjakSDconvert);
            target.select("#info").text("Total weekly from All Origins (detail below) : "+totalreceiveSD+" species");
            d3.select("#ljkt1R").text(totalreceiveSD+" species");
            var JakTable = tabulate2(datamovjakSDconvertaddtot);

            minmaxvaljvSD = getMaxTot(datamovjakSDconvertaddtot)
            deviderLegend(minmaxvaljvSD,"JV")

            //get the origin cities based on selected destination
            var oricitySD = getOriginCity(d,"subdistrict");

            //generate all selected origin city on Java Map
            dt_resSD = dt(javjson,oricitySD);

            //added total value to the data
            for (var i = 0; i < dt_resSD.length; i++)
            {
                for (var j = 0; j < datamovjakSDconvertaddtot.length; j++)
                {
                    if (dt_resSD[i].properties.KAB_KOTA == datamovjakSDconvertaddtot[j].ori)
                    {
                        dt_resSD[i].properties.total = datamovjakSDconvertaddtot[j].total
                    }
                }
            }

            //generate selected district on JAVA map
            map2.selectAll("path")
                .data(dt_resSD, function(d)
                {
                    return d.properties.OBJECTID;
                })
                .style("fill", setJavColorSDLBM)
                .attr("stroke-width", 2)
                .each(function(d,i)
                    {
                        if (connectionmenu[0] == "Line")
                        {
                            endpoint[i] = getCentroid(d3.select(this))
                            generateCentralDistrict(endpoint[i],gjw)
                            drawlineDest2Ori(startpoint,endpoint[i],"black")
                        }
                    });
        }

        function JKT_rect_onclick(sel_this,d)
        {

            //returned all circles default colour
            gjkt.selectAll("rect").style("fill", setJktColorSDLBM)
            JV_unselected_state(d)

            /* generate select-self SD position and Bubble text */
            sel_this.style("fill", "orange");

            d3.selectAll("#c_id").remove();
            d3.selectAll("#line_id").remove();
            if (connectionmenu[0] == "Line")
            {
                //startpoint = getCentroid(sel_this);
                generateCentralDistrict(this,gjkt)
            }

            target.select("#daerah").text("DESTINATION LBM :"+d.name);

            //Show tooltip
            d3.select("#tooltip").classed("hidden", false);

            var totalreceive = 0;
            /* generate Legend */
            JVJKT_legend_set("JKT");

            /* generate table info */
            getInfoOrifromDest(d,"lbm")
            var datamovjakLBMconvert = DataConverter2(datamovjakLBM,"dest_to_ori","lbm");
            var datamovjakLBMconvertaddtot = addTotalField(datamovjakLBMconvert);
            var totalreceiveLBM = addTotalSendOrReceive(datamovjakLBMconvert);
            target.select("#info").text("Total weekly from All Origins (detail below) : "+totalreceiveLBM+" species");
            d3.select("#ljkt1R").text(totalreceiveLBM+" species");
            var JakTable = tabulate2(datamovjakLBMconvertaddtot);

            minmaxvaljvLBM = getMaxTot(datamovjakLBMconvertaddtot)
            deviderLegend(minmaxvaljvLBM,"JV")

            //get the origin cities based on selected destination
            var selecteddata = getDistrictBasedOnMarketCode(d);
            var oricityLBM = getOriginCity(selecteddata,"lbm");

            //generate all selected origin city on Java Map
            dt_resLBM = dt(javjson,oricityLBM);

            //added total value to the data
            for (var i = 0; i < dt_resLBM.length; i++)
            {
                for (var j = 0; j < datamovjakLBMconvertaddtot.length; j++)
                {
                    if (dt_resLBM[i].properties.KAB_KOTA == datamovjakLBMconvertaddtot[j].ori)
                    {
                        dt_resLBM[i].properties.total = datamovjakLBMconvertaddtot[j].total
                    }
                }
            }

            map2.selectAll("path")
                .data(dt_resLBM, function(d)
                {
                    return d.properties.OBJECTID;
                })
                .style("fill", setJavColorSDLBM)
                .attr("stroke-width", 2)
                .each(function(d,i)
                    {
                        if (connectionmenu[0] == "Line")
                        {
                            endpoint[i] = getCentroid(d3.select(this))
                            generateCentralDistrict(endpoint[i],gjw)
                            drawlineDest2Ori(startpoint,endpoint[i],"black")
                        }
                    });
        }

        function JV_path_onclick()
        {

            JVForFilter.style("fill", setNormalColor(JVDvalueForFilter));

            //set to unselected state
            JV_unselected_state(JVDvalueForFilter);

            gjkt.selectAll("circle").remove();
            gjkt.selectAll("rect").remove();

            /* generate select-self district position and Bubble text */
            JVForFilter.style("fill", "purple");

            d3.selectAll("#c_id").remove();
            d3.selectAll("#line_id").remove();
            if (connectionmenu[0] == "Line")
            {
                startpoint = getCentroid(JVForFilter);
                generateCentralDistrict(startpoint,gjw)
            }

            target.select("#daerah").text("Origin : "+JVDvalueForFilter.properties.KAB_KOTA+" - " + JVDvalueForFilter.properties.PROPINSI);

            //Show tooltip
            d3.select("#tooltip").classed("hidden", false);


            var totalsend = 0;
            /* generate Legend */
            JVJKT_legend_set("JV");

            /* generate table info */
            if (destinationmenu[0] == "District" || typeof destinationmenu[0] == 'undefined')
            {
                getInfoDestfromOri(JVDvalueForFilter,"district");
                var datamovjavconvert = DataConverter2(datamovjav,"ori_to_dest","district");
                var datamovjavconvertaddtot = addTotalField(datamovjavconvert);
                totalsend = addTotalSendOrReceive(datamovjavconvert);
                target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsend+" species");
                d3.select("#ljv1R").text(totalsend+" species");
                var JavTable = tabulate2(datamovjavconvertaddtot);
                minmaxvaljkt = getMaxTot(datamovjavconvertaddtot);
                deviderLegend(minmaxvaljkt,"JKT")

                getInfoDestfromOri(JVDvalueForFilter,"subdistrict");
                var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");
                var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
                totalsendSD = addTotalSendOrReceive(datamovjavconvertSD);

                getInfoDestfromOri(JVDvalueForFilter,"lbm");
                var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");
                var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
                totalsendLBM = addTotalSendOrReceive(dt_lbm);
            }
            else if (destinationmenu[0] == "SubDistrict" )
            {
                getInfoDestfromOri(JVDvalueForFilter,"subdistrict");
                var datamovjavconvertSD = DataConverter2(datamovjavSD,"ori_to_dest","subdistrict");
                var datamovjavconvertaddtotSD = addTotalField(datamovjavconvertSD);
                totalsendSD = addTotalSendOrReceive(datamovjavconvertSD);
                target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendSD+" species");
                d3.select("#ljv1R").text(totalsendSD+" species");
                var JavTable = tabulate2(datamovjavconvertaddtotSD);
                minmaxvaljkt = getMaxTot(datamovjavconvertaddtotSD);
                deviderLegend(minmaxvaljkt,"JKT")

                getInfoDestfromOri(JVDvalueForFilter,"lbm");
                var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");
                var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);
                totalsendLBM = addTotalSendOrReceive(dt_lbm);
            }
            else if (destinationmenu[0] == "LBM")
            {
                getInfoDestfromOri(JVDvalueForFilter,"lbm");
                var datamovjavconvertLBM = DataConverter2(datamovjavLBM,"ori_to_dest","lbm");
                var datamovjavconvertaddtotLBM = addTotalField(datamovjavconvertLBM);

                //convert cy_id_new into LBM name
                d3.csv("dest2lbm.csv", function(lbms)
                {
                    var dt_lbm = [];
                    var n = 0;
                    for (var i = 0; i < lbms.length; i++)
                    {
                        for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
                        {
                            if(lbms[i].marketCode == datamovjavconvertaddtotLBM[j].dest)
                            {
                                dt_lbm[n] = datamovjavconvertaddtotLBM[j];
                                dt_lbm[n].dest = lbms[i].name
                                n = n + 1;
                            }
                        }
                    }
                    var JavTable = tabulate2(dt_lbm);
                    minmaxvaljkt = getMaxTot(dt_lbm);
                    deviderLegend(minmaxvaljkt,"JKT")
                    totalsendLBM = addTotalSendOrReceive(dt_lbm);
                    target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendLBM+" species");
                    d3.select("#ljv1R").text(totalsendLBM+" species");
                })
            }

            /* generate position district on JKT MAP */
            if (destinationmenu[0] == "District" || typeof destinationmenu[0] == 'undefined' )
            {
                //get the origin cities based on selected destination
                var destcity = getDestCity(JVDvalueForFilter, "district");
                var dataselectedD = dt(jakjson, destcity);

                for (var i = 0; i < dataselectedD.length; i++)
                {
                    for (var j = 0; j < datamovjavconvertaddtot.length; j++)
                    {
                        if (dataselectedD[i].properties.KAB_KOTA == datamovjavconvertaddtot[j].dest)
                        {
                            dataselectedD[i].properties.total = datamovjavconvertaddtot[j].total
                        }
                    }
                }

                //generate selected district on JKT map
                map.selectAll("path")
                    .data(dataselectedD, function(d) { return d.properties.OBJECTID; })
                    .style("fill", setJktColor)
                    .attr("stroke-width", 2)
                    .each(function(d,i)
                    {
                        if (connectionmenu[0] == "Line")
                        {
                            endpoint[i] = getCentroid(d3.select(this))
                            generateCentralDistrict(endpoint[i],gjkt)
                            drawlineOri2Dest(startpoint,endpoint[i],"black")
                        }
                    });
            }

            /* generate position subdistrict */
            if (destinationmenu[0] == "SubDistrict" || destinationmenu[1]=="SubDistrict" || typeof destinationmenu[0] == 'undefined')
            {
                var destsd = getDestCity(JVDvalueForFilter, "subdistrict");
                var dtsd = function(datassd)
                {
                    d3.csv("dest1dki.csv", function(sds)
                    {
                        var result = [];
                        var n = 0;
                        var possd = [];
                        for (var i = 0; i < datassd.length; i++)
                        {
                            var dataState = datassd[i];
                            //Find the corresponding state inside the GeoJSON
                            for (var j = 0; j < sds.length; j++)
                            {
                                var jsonState = sds[j].subdistrict;
                                if (dataState == jsonState )
                                {
                                    result[n] = sds[j];
                                    var Lat = (-1*sds[j].gps_north_degree) - (+sds[j].gps_north_minute/100),
                                    Long = (1*sds[j].gps_east_degree) + (+sds[j].gps_east_minute/100),
                                    location = [+Long, +Lat];
                                    sds[j].location = location;
                                    possd.push(projection(location));
                                    n = n + 1;
                                    break;
                                }
                            }
                        }

                        var g = gjkt.selectAll("g")
                                    .data(result)
                                    .append("svg:g");


                        for (var i = 0; i < result.length; i++)
                        {
                            for (var j = 0; j < datamovjavconvertaddtotSD.length; j++)
                            {
                                if (result[i].subdistrict == datamovjavconvertaddtotSD[j].dest)
                                {
                                    result[i].total = datamovjavconvertaddtotSD[j].total
                                }
                            }
                        }

                        //generate the circles
                        showCity(result,gjkt,possd,setJktColorSDLBM, "circle");

                        if (connectionmenu[0] == "Line" && (collectormenu[0] == "SubDistrict" || collectormenu[1] == "SubDistrict" ))
                        {
                            for (var i = 0; i < possd.length; i++)
                            {
                                drawlineOri2Dest(startpoint,possd[i],"red")
                            }
                        }

                        gjkt.selectAll("circle")
                        .on("click", function(JVDvalueForFilter)
                        {
                            var circleselected = d3.select(this);
                            JKT_circle_onclick(circleselected,JVDvalueForFilter)
                        })
                        .on("mouseover", function(d)
                        {
                            var coordinates = [0, 0];
                                coordinates = d3.mouse(this);

                            var target2 = d3.select("#tooltip2")
                                .style("left", coordinates[0] + (7*margin) + "px")
                                .style("top", coordinates[1] + (7*margin) + "px");

                            target2.select("#daerah").text("Destination : "+d.subdistrict);

                            //Show tooltip
                            d3.select("#tooltip2").classed("hidden", false);

                        })
                        .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});
                    })
                };
                var dataselectedsd = dtsd(destsd);
            }
            /* generate position LBM */
            if (destinationmenu[0] == "LBM" || destinationmenu[1] == "LBM" || destinationmenu[2] == "LBM" || typeof destinationmenu[0] == 'undefined')
            {
                var destlbm = getDestCity(JVDvalueForFilter, "lbm");
                var dtlbm = function(dataslbm)
                {
                    d3.csv("dest2lbm.csv", function(lbms)
                    {
                        var result = [];
                        var n = 0;
                        var poslbm = [];
                        for (var i = 0; i < dataslbm.length; i++)
                        {
                            var dataState = dataslbm[i];
                            for (var j = 0; j < lbms.length; j++)
                            {
                                var jsonState = lbms[j].marketCode;
                                if (dataState == jsonState )
                                {
                                    result[n] = lbms[j];
                                    var Lat = (-1*lbms[j].LS_Coord_Deg) - (+lbms[j].LS_Coord_Min/100),
                                    Long = (1*lbms[j].BT_Coord_Deg) + (+lbms[j].BT_Coord_Min/100),
                                    location = [+Long, +Lat];
                                    lbms[j].location = location;
                                    poslbm.push(projection(location));
                                    n = n + 1;
                                    break;
                                }
                            }
                        }

                        var g = gjkt.selectAll("g")
                                    .data(result)
                                    .append("svg:g");

                        for (var i = 0; i < result.length; i++)
                        {
                            for (var j = 0; j < datamovjavconvertaddtotLBM.length; j++)
                            {
                                if (result[i].name == datamovjavconvertaddtotLBM[j].dest)
                                {
                                    result[i].total = datamovjavconvertaddtotLBM[j].total
                                }
                            }
                        }

                        //generate the circles
                        showCity(result,gjkt,poslbm,setJktColorSDLBM, "rect");

                        if (connectionmenu[0] == "Line" && (collectormenu[0] == "LBM" || collectormenu[1] == "LBM" || collectormenu[2] == "LBM"))
                        {
                            for (var i = 0; i < poslbm.length; i++)
                            {
                                drawlineOri2Dest(startpoint,poslbm[i],"blue")
                            }
                        }

                        gjkt.selectAll("rect")
                        .on("click", function(JVDvalueForFilter)
                        {
                            var rectselected = d3.select(this);
                            JKT_rect_onclick(rectselected,JVDvalueForFilter);
                        })
                        .on("mouseover", function(d)
                        {
                            var coordinates = [0, 0];
                                coordinates = d3.mouse(this);

                            var target2 = d3.select("#tooltip2")
                                .style("left", coordinates[0] + (7*margin) +"px")
                                .style("top", coordinates[1] + (7*margin) + "px");

                            target2.select("#daerah").text("Destination : "+d.name);

                            //Show tooltip
                            d3.select("#tooltip2").classed("hidden", false);

                        })
                        .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});
                    })
                };
                var dataselectedlbm = dtlbm(destlbm);
            }
        }

        function JKT_path_onclick()
        {
            JKTForFilter.style("fill", setNormalColor(JKTDvalueForFilter));
            JV_unselected_state(JKTDvalueForFilter)

            JKTForFilter.style("fill", "orange");

            d3.selectAll("#c_id").remove();
            d3.selectAll("#line_id").remove();
            if (connectionmenu[0] == "Line")
            {
                startpoint = getCentroid(JKTForFilter);
                generateCentralDistrict(startpoint,gjkt)
            }

            target.select("#daerah").text("DESTINATION :"+JKTDvalueForFilter.properties.KAB_KOTA);

            //Show tooltip
            d3.select("#tooltip").classed("hidden", false);

            var totalreceive = 0;
            /* generate Legend */
            JVJKT_legend_set("JKT");

            /* generate table info */
            getInfoOrifromDest(JKTDvalueForFilter,"district")
            var datamovjakconvert = DataConverter2(datamovjak,"dest_to_ori","district");
            var datamovjakconvertaddtot = addTotalField(datamovjakconvert);
            totalreceive = addTotalSendOrReceive(datamovjakconvert);
            target.select("#info").text("Total weekly from All Origins (detail below) : "+totalreceive+" species");
            d3.select("#ljkt1R").text(totalreceive+" species");
            var JakTable = tabulate2(datamovjakconvertaddtot);

            minmaxvaljv = getMaxTot(datamovjakconvertaddtot)
            deviderLegend(minmaxvaljv,"JV")

            //get the origin cities based on selected destination
            var oricity = getOriginCity(JKTDvalueForFilter,"district");

            //generate all selected origin city on Java Map
            dt_res = dt(javjson,oricity);

            //added total value to the data
            for (var i = 0; i < dt_res.length; i++)
            {
                for (var j = 0; j < datamovjakconvertaddtot.length; j++)
                {
                    if (dt_res[i].properties.KAB_KOTA == datamovjakconvertaddtot[j].ori)
                    {
                        dt_res[i].properties.total = datamovjakconvertaddtot[j].total
                    }
                }
            }
            var ptjv = map2.selectAll("path")
                .data(dt_res, function(d)
                {
                    return d.properties.OBJECTID;
                })
                .style("fill", setJavColor)
                .attr("stroke-width", 2)
                .each(function(d,i)
                    {
                        if (connectionmenu[0] == "Line")
                        {
                            endpoint[i] = getCentroid(d3.select(this))
                            generateCentralDistrict(endpoint[i],gjw)
                            drawlineDest2Ori(startpoint,endpoint[i],"black")
                        }
                    });


        }

        function JKTFS_path_onclick()
        {
            JKTFSForFilter.style("fill", setNormalColor(JKTFSDvalueForFilter));
            JV_unselected_state(JKTFSDvalueForFilter)

            JKTFSForFilter.style("fill", "orange");

            /*
            d3.selectAll("#c_id").remove();
            d3.selectAll("#line_id").remove();
            if (connectionmenu[0] == "Line")
            {
                startpoint = getCentroid(JKTForFilter);
                generateCentralDistrict(startpoint,gjktFS)
            }
            */

            target.select("#daerah").text("DESTINATION :"+JKTFSDvalueForFilter.properties.KAB_KOTA);

            //Show tooltip
            d3.select("#tooltip").classed("hidden", false);

            var totalreceive = 0;
            /* generate Legend */
            JVJKT_legend_set("JV");

            /* generate table info */
            if (destinationmenu[0] == "SubDistrict" || typeof destinationmenu[0] == 'undefined' )
            {
                getInfoCY_SDnLBMfromCY_D(JKTFSDvalueForFilter,"subdistrict");
                var datamovjakFSconvertSD = DataConverter2(datamovjakFSSD,"ori_to_dest","subdistrict");
                var datamovjakFSconvertaddtotSD = addTotalField(datamovjakFSconvertSD);
                totalsendFSSD = addTotalSendOrReceive(datamovjakFSconvertSD);
                target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendFSSD+" species");
                d3.select("#ljv1R").text(totalsendFSSD+" species");
                var JakFSTable = tabulate2(datamovjakFSconvertaddtotSD);
                minmaxvaljktFS = getMaxTot(datamovjakFSconvertaddtotSD);
                deviderLegend(minmaxvaljktFS,"JKT")

                getInfoCY_SDnLBMfromCY_D(JKTFSDvalueForFilter,"lbm");
                var datamovjakFSconvertLBM = DataConverter2(datamovjakFSLBM,"ori_to_dest","lbm");
                var datamovjakFSconvertaddtotLBM = addTotalField(datamovjakFSconvertLBM);
                //totalsendLBMFS = addTotalSendOrReceive(dt_lbm);
            }
            else if (destinationmenu[0] == "LBM")
            {
                getInfoCY_SDnLBMfromCY_D(JVDvalueForFilter,"lbm");
                var datamovjakFSconvertLBM = DataConverter2(datamovjakFSLBM,"ori_to_dest","lbm");
                var datamovjakFSconvertaddtotLBM = addTotalField(datamovjakFSconvertLBM);

                //convert cy_id_new into LBM name
                d3.csv("dest2lbm.csv", function(lbms)
                {
                    var dt_lbm = [];
                    var n = 0;
                    for (var i = 0; i < lbms.length; i++)
                    {
                        for (var j = 0; j < datamovjakFSconvertaddtotLBM.length; j++)
                        {
                            if(lbms[i].marketCode == datamovjakFSconvertaddtotLBM[j].dest)
                            {
                                dt_lbm[n] = datamovjakFSconvertaddtotLBM[j];
                                dt_lbm[n].dest = lbms[i].name
                                n = n + 1;
                            }
                        }
                    }
                    var JavTable = tabulate2(dt_lbm);
                    minmaxvaljktFS = getMaxTot(dt_lbm);
                    deviderLegend(minmaxvaljkt,"JKT")
                    totalsendLBMFS = addTotalSendOrReceive(dt_lbm);
                    target.select("#info").text("Total weekly to All destinations (detail below) : "+totalsendLBMFS+" species");
                    d3.select("#ljv1R").text(totalsendLBMFS+" species");
                })
            }

            /* generate position subdistrict */
            if (destinationmenu[0] == "SubDistrict" || destinationmenu[1]=="SubDistrict" || typeof destinationmenu[0] == 'undefined')
            {
                var destsd = getDestCity(JKTFSDvalueForFilter, "subdistrict");
                var dtsd = function(datassd)
                {
                    d3.csv("dest1dki.csv", function(sds)
                    {
                        var result = [];
                        var n = 0;
                        var possd = [];
                        for (var i = 0; i < datassd.length; i++)
                        {
                            var dataState = datassd[i];
                            //Find the corresponding state inside the GeoJSON
                            for (var j = 0; j < sds.length; j++)
                            {
                                var jsonState = sds[j].subdistrict;
                                if (dataState == jsonState )
                                {
                                    result[n] = sds[j];
                                    var Lat = (-1*sds[j].gps_north_degree) - (+sds[j].gps_north_minute/100),
                                    Long = (1*sds[j].gps_east_degree) + (+sds[j].gps_east_minute/100),
                                    location = [+Long, +Lat];
                                    sds[j].location = location;
                                    possd.push(projectionFS(location));
                                    n = n + 1;
                                    break;
                                }
                            }
                        }

                        var g = gjktFS.selectAll("g")
                                    .data(result)
                                    .append("svg:g");


                        for (var i = 0; i < result.length; i++)
                        {
                            for (var j = 0; j < datamovjakFSconvertaddtotSD.length; j++)
                            {
                                if (result[i].subdistrict == datamovjakFSconvertaddtotSD[j].dest)
                                {
                                    result[i].total = datamovjakFSconvertaddtotSD[j].total
                                }
                            }
                        }

                        //generate the circles
                        showCity(result,gjktFS,possd,setJktColorSDLBM, "circle");

                        if (connectionmenu[0] == "Line" && (collectormenu[0] == "SubDistrict" || collectormenu[1] == "SubDistrict" ))
                        {
                            for (var i = 0; i < possd.length; i++)
                            {
                                drawlineOri2Dest(startpoint,possd[i],"red")
                            }
                        }

                        gjktFS.selectAll("circle")
                        .on("click", function(JKTFSDvalueForFilter)
                        {
                            var circleselected = d3.select(this);
                            //JKT_circle_onclick(circleselected,JKTFSDvalueForFilter)
                        })
                        .on("mouseover", function(d)
                        {
                            var coordinates = [0, 0];
                                coordinates = d3.mouse(this);

                            var target2 = d3.select("#tooltip2")
                                .style("left", coordinates[0] + (7*margin) + "px")
                                .style("top", coordinates[1] + (7*margin) + "px");

                            target2.select("#daerah").text("Destination : "+d.subdistrict);

                            //Show tooltip
                            d3.select("#tooltip2").classed("hidden", false);

                        })
                        .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});
                    })
                };
                var dataselectedsd = dtsd(destsd);
            }
            /* generate position LBM */
            if (destinationmenu[0] == "LBM" || destinationmenu[1] == "LBM" || destinationmenu[2] == "LBM" || typeof destinationmenu[0] == 'undefined')
            {
                var destlbm = getDestCity(JKTFSDvalueForFilter, "lbm");
                var dtlbm = function(dataslbm)
                {
                    d3.csv("dest2lbm.csv", function(lbms)
                    {
                        var result = [];
                        var n = 0;
                        var poslbm = [];
                        for (var i = 0; i < dataslbm.length; i++)
                        {
                            var dataState = dataslbm[i];
                            for (var j = 0; j < lbms.length; j++)
                            {
                                var jsonState = lbms[j].marketCode;
                                if (dataState == jsonState )
                                {
                                    result[n] = lbms[j];
                                    var Lat = (-1*lbms[j].LS_Coord_Deg) - (+lbms[j].LS_Coord_Min/100),
                                    Long = (1*lbms[j].BT_Coord_Deg) + (+lbms[j].BT_Coord_Min/100),
                                    location = [+Long, +Lat];
                                    lbms[j].location = location;
                                    poslbm.push(projectionFS(location));
                                    n = n + 1;
                                    break;
                                }
                            }
                        }

                        var g = gjktFS.selectAll("g")
                                    .data(result)
                                    .append("svg:g");

                        for (var i = 0; i < result.length; i++)
                        {
                            for (var j = 0; j < datamovjakFSconvertaddtotLBM.length; j++)
                            {
                                if (result[i].name == datamovjakFSconvertaddtotLBM[j].dest)
                                {
                                    result[i].total = datamovjakFSconvertaddtotLBM[j].total
                                }
                            }
                        }

                        //generate the circles
                        showCity(result,gjktFS,poslbm,setJktColorSDLBM, "rect");

                        if (connectionmenu[0] == "Line" && (collectormenu[0] == "LBM" || collectormenu[1] == "LBM" || collectormenu[2] == "LBM"))
                        {
                            for (var i = 0; i < poslbm.length; i++)
                            {
                                drawlineOri2Dest(startpoint,poslbm[i],"blue")
                            }
                        }

                        gjktFS.selectAll("rect")
                        .on("click", function(JKTFSDvalueForFilter)
                        {
                            var rectselected = d3.select(this);
                            //JKT_rect_onclick(rectselected,JKTFSDvalueForFilter);
                        })
                        .on("mouseover", function(d)
                        {
                            var coordinates = [0, 0];
                                coordinates = d3.mouse(this);

                            var target2 = d3.select("#tooltip2")
                                .style("left", coordinates[0] + (7*margin) +"px")
                                .style("top", coordinates[1] + (7*margin) + "px");

                            target2.select("#daerah").text("Destination : "+d.name);

                            //Show tooltip
                            d3.select("#tooltip2").classed("hidden", false);

                        })
                        .on("mouseout", function(d){d3.select("#tooltip2").classed("hidden", true);});
                    })
                };
                var dataselectedlbm = dtlbm(destlbm);
            }

        }

        function getCentroid(selection)
        {
            // get the DOM element from a D3 selection
            // you could also use "this" inside .each()
            var element = selection.node(),
                // use the native SVG interface to get the bounding box
                bbox = element.getBBox();
            // return the center of the bounding box
            //return
            var poscent = [bbox.x + bbox.width/2, bbox.y + bbox.height/2];
            return poscent
        }

        function generateCentralDistrict(selectedcentroid,canvas)
        {
            var post = selectedcentroid
            var circle = canvas.append("circle")
                                .attr("id","c_id")
                                .attr("cx", post[0])
                                .attr("cy", post[1])
                                .attr("r", 5);
        }

        function drawlineDest2Ori(startpoint,endpoint,color)
        {
            var circle = canvas.append("line")
                                .attr("id","line_id")
                                .attr("x1", startpoint[0])
                                .attr("y1", startpoint[1])
                                .attr("x2", endpoint[0])
                                .attr("y2", jkth+endpoint[1])
                                .attr("stroke-width", 2)
                                .attr("stroke", color);
        }

        function drawlineOri2Dest(startpoint,endpoint,color)
        {
            var circle = canvas.append("line")
                                .attr("id","line_id")
                                .attr("x1", startpoint[0])
                                .attr("y1", jkth+startpoint[1])
                                .attr("x2", endpoint[0])
                                .attr("y2", endpoint[1])
                                .attr("stroke-width", 2)
                                .attr("stroke", color);
        }

        function displayoption ()
        {
            var checkbox = svg.append("foreignObject")
                                .attr("x", margin)
                                .attr("y", 5*margin)
                                .attr("width", 150)
                                .attr("height",100)
                                .append("xhtml:body")
                                .append("div")
                                .attr("id", "op1")
                                .text("OPTIONS  : ")
                                .append("input")
                                .attr("type","checkbox")
                                .attr("id", "cb1")
                                .on("change", function ()
                                {
                                    if (d3.select(this).node().checked)
                                    {
                                        d3.select("#gjkt_rect").classed("hidden", true);
                                        canvas.selectAll("line").remove();
                                        map.selectAll("circle").remove();
                                        map.selectAll("path").remove();
                                        d3.select("#gjw_rect").classed("hidden", true);
                                        map2.selectAll("circle").remove();
                                        map2.selectAll("path").remove();
                                        d3.select("#gjktFS_rect").classed("hidden", false);

                                        //added Full jabodetabek map
                                        d3.json("jakarta.json", function(json) {
                                            jakFSjson = json;
                                            FSMapJKT(json);
                                        });

                                        if(d3.select("#f1").empty())
                                        {
                                            filter1();
                                        }
                                        d3.select("#f1").classed("hidden", false);
                                        d3.select("#f2").classed("hidden", true);
                                        d3.select("#f3").classed("hidden", true);

                                    }
                                    else
                                    {
                                        d3.select("#gjktFS_rect").classed("hidden", true);
                                        canvas.selectAll("line").remove();
                                        map3.selectAll("circle").remove();
                                        map3.selectAll("path").remove();
                                        d3.select("#gjkt_rect").classed("hidden", false);
                                        d3.select("#gjw_rect").classed("hidden", false);

                                        //added jabodetabek map
                                        d3.json("jakarta.json", function(json) {
                                            jakjson = json;
                                            updateMapJKT(json);
                                        });

                                        // generate SVG for second Geojson MAP (java island)
                                        d3.json("indonesia_districts_java_only.json", function(json) {
                                            javjson = json;
                                            updateMapJAVA(json);
                                        });

                                        if(d3.select("#f2").empty())
                                        {
                                            filter2();
                                            filter3();
                                        }
                                        d3.select("#f1").classed("hidden", true);
                                        d3.select("#f2").classed("hidden", false);
                                        d3.select("#f3").classed("hidden", false);
                                    }

                                });
        }

        function filter1()
        {
            var filter1a = svg.append("foreignObject")
                                .attr("x", jktw+margin)
                                .attr("y", 6*margin)
                                .attr("width", 1000)
                                .attr("height",1000)

            var filter1adiv = filter1a.append("xhtml:body")
                                    .append("div")
                                    .attr("id", "f1")

            filter1adiv.html("<fieldset class=group>"
                                +"<legend>Search Markets and Collector in JABODETABEK</legend> "
                                +"<fieldset class=group>"
                                +"<legend>Search Collectors connected to a Market</legend> "
                                +"</br></br>"
                                +"<input type=checkbox id=f1cb1 class=tick/>"
                                +"By Name or Number :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb2 class=tick/>"
                                +"All markets in sub-district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb3 class=tick/>"
                                +"All markets in district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br></br>"
                                +"<input type=checkbox id=f1spcb1a class=tick/>"
                                +"Ayam Kampung "
                                +"<input type=checkbox id=f1spcb2a class=tick/>"
                                +"Broiler "
                                +"<input type=checkbox id=f1spcb3a class=tick/>"
                                +"Duck "
                                +"<input type=checkbox id=f1spcb4a class=tick/>"
                                +"Layer "
                                +"<input type=checkbox id=f1spcb5a class=tick/>"
                                +"All "
                                +"</br></br>"
                                +"</fieldset> "
                                +"</br></br>"
                                +"<fieldset class=group>"
                                +"<legend>Search Markets connected to a Collector</legend> "
                                +"</br></br>"
                                +"<input type=checkbox id=f1cb1 class=tick/>"
                                +"By Name or Number :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb2 class=tick/>"
                                +"All markets in sub-district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb3 class=tick/>"
                                +"All markets in district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br></br>"
                                +"<input type=checkbox id=f1spcb1b class=tick/>"
                                +"Ayam Kampung "
                                +"<input type=checkbox id=f1spcb2b class=tick/>"
                                +"Broiler "
                                +"<input type=checkbox id=f1spcb3b class=tick/>"
                                +"Duck "
                                +"<input type=checkbox id=f1spcb4b class=tick/>"
                                +"Layer "
                                +"<input type=checkbox id=f1spcb5b class=tick/>"
                                +"All "
                                +"</br></br>"
                                +"</fieldset> "
                                +"</fieldset> ")
            .on("click", function(d, i)
            {
                console.log(svg.select("#f1spcb5a").node().checked)
                if (svg.select("#f1spcb5a").node().checked == "true")
                {
                    svg.select("#f1spcb1a").node().checked = "true";
                    svg.select("#f1spcb2a").node().checked = "true";
                    svg.select("#f1spcb3a").node().checked = "true";
                    svg.select("#f1spcb4a").node().checked = "true";
                    svg.select("#f1spcb1b").node().checked = "true";
                    svg.select("#f1spcb2b").node().checked = "true";
                    svg.select("#f1spcb3b").node().checked = "true";
                    svg.select("#f1spcb4b").node().checked = "true";
                    svg.select("#f1spcb5b").node().checked = "true";
                }

            }) ;
        }

        function filter2()
        {
            var filter2a = svg.append("foreignObject")
                                .attr("x", jktw+margin)
                                .attr("y", 6*margin)
                                .attr("width", 1000)
                                .attr("height",1000)

            var filter2adiv = filter2a.append("xhtml:body")
                                    .append("div")
                                    .attr("id", "f2")

            filter2adiv.html("<fieldset class=group>"
                                +"<legend>Search Poultry District of Origin of Poultry in Jakarta </legend> "
                                +"<fieldset class=group>"
                                +"<legend>Search Districts of poultry origin of Collectors </legend> "
                                +"</br></br>"
                                +"<input type=checkbox id=f1cb1 class=tick/>"
                                +"By Name or Number :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb2 class=tick/>"
                                +"All markets in sub-district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb3 class=tick/>"
                                +"All markets in district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br></br>"
                                +"<input type=checkbox id=f1spcb1 class=tick/>"
                                +"Ayam Kampung "
                                +"<input type=checkbox id=f1spcb2 class=tick/>"
                                +"Broiler "
                                +"<input type=checkbox id=f1spcb3 class=tick/>"
                                +"Duck "
                                +"<input type=checkbox id=f1spcb4 class=tick/>"
                                +"Layer "
                                +"<input type=checkbox id=f1spcb5 class=tick/>"
                                +"All "
                                +"</br></br>"
                                +"</fieldset> "
                                +"</br></br>"
                                +"<fieldset class=group>"
                                +"<legend>Search Districts of poultry origin of Livebird markets*</legend> "
                                +"</br></br>"
                                +"<input type=checkbox id=f1cb1 class=tick/>"
                                +"By Name or Number :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb2 class=tick/>"
                                +"All markets in sub-district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb3 class=tick/>"
                                +"All markets in district :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br></br>"
                                +"<input type=checkbox id=f1spcb1 class=tick/>"
                                +"Ayam Kampung "
                                +"<input type=checkbox id=f1spcb2 class=tick/>"
                                +"Broiler "
                                +"<input type=checkbox id=f1spcb3 class=tick/>"
                                +"Duck "
                                +"<input type=checkbox id=f1spcb4 class=tick/>"
                                +"Layer "
                                +"<input type=checkbox id=f1spcb5 class=tick/>"
                                +"All "
                                +"</br></br>"
                                +"* ONLY FOR POULTRY CONNECTED TO COLLECTORS IN JABODETABEK"
                                +"</fieldset> "
                                +"</fieldset> ")
            .on("click", function(d, i)
            {
                console.log(svg.select("#f1cb1").node().checked)

            }) ;
        }

        function filter3()
        {
            var filter3a = svg.append("foreignObject")
                                .attr("x", jktw+margin)
                                .attr("y", 26*margin)
                                .attr("width", 1000)
                                .attr("height",1000)

            var filter3adiv = filter3a.append("xhtml:body")
                                    .append("div")
                                    .attr("id", "f3")

            filter3adiv.html("<fieldset class=group>"
                                +"<legend>Search Destination of birds from a district  </legend> "
                                +"<fieldset class=group>"
                                +"<legend>Search Destinations of birds district of origin </legend> "
                                +"</br></br>"
                                +"<input type=checkbox id=f1cb1 class=tick/>"
                                +"Display only LBM destination :"
                                +"<input type=text id=f1tx1 class=tick/>"
                                +"</br>"
                                +"<input type=checkbox id=f1cb2 class=tick/>"
                                +"Display only collector destinations"
                                +"</br>"
                                +"<input type=checkbox id=f1cb3 class=tick/>"
                                +"Display collector and LBM destination"
                                +"</br></br>"
                                +"<input type=checkbox id=f1spcb1 class=tick/>"
                                +"Ayam Kampung "
                                +"<input type=checkbox id=f1spcb2 class=tick/>"
                                +"Broiler "
                                +"<input type=checkbox id=f1spcb3 class=tick/>"
                                +"Duck "
                                +"<input type=checkbox id=f1spcb4 class=tick/>"
                                +"Layer "
                                +"<input type=checkbox id=f1spcb5 class=tick/>"
                                +"All "
                                +"</br></br>"
                                +"</fieldset> "
                                +"</br></br>"
                                +"</fieldset> "
                                +"</fieldset> ")
            .on("click", function(d, i)
            {
                console.log(svg.select("#f1cb1").node().checked)

            }) ;
        }

/****************************************************************************************/
        //set the interface

        //get data from the movement csv
        getcsvdata();
        //keep original data to other variable
        datdum();

        //added  title for the interface
        titleinterface()

        //added filter(s)
        Filter1_Origins();
        Filter2_Collectors();
        Filter3_Destinations();
        Filter4_Species();
        Filter5_Connections();

        displayoption();

        filter1()
        filter2()
        filter3()
        d3.select("#f1").classed("hidden", true);
        d3.select("#f2").classed("hidden", true);
        d3.select("#f3").classed("hidden", true);


        d3.select("#gjkt_rect").classed("hidden", true);
        d3.select("#gjw_rect").classed("hidden", true);
        d3.select("#gjktFS_rect").classed("hidden", true);


/****************************************************************************************/

    </script>

</body>

</html>